<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Custom Receiver / Fix .html TS segments</title>
<script src="https://cdn.jsdelivr.net/npm/shaka-player@4.4.0/dist/shaka-player.compiled.js"></script>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#9aa6b2;}
  html,body{height:100%;margin:0;font-family:Inter,system-ui;}
  body{background:#071427;color:#e6eef3;display:flex;align-items:center;justify-content:center;}
  .wrap{max-width:1000px;width:calc(100% - 24px);margin:24px;background:var(--card);
        border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
  video{width:100%;height:360px;background:#000;border-radius:10px;}
  input,button{font:inherit}
  input[type=text]{background:#0b1220;border:1px solid rgba(255,255,255,0.08);color:#e6eef3;
                   padding:8px 10px;border-radius:8px;width:60%}
  button{background:linear-gradient(90deg,var(--accent),#3b82f6);border:none;
         color:#042028;padding:8px 14px;border-radius:8px;font-weight:600;cursor:pointer;}
  .log{height:220px;overflow:auto;background:#031018;border-radius:8px;
       font-family:monospace;font-size:12px;color:var(--muted);padding:8px;margin-top:10px;}
</style>
</head>
<body>
<div class="wrap">
  <h2>HLS / DASH Debug Player — fixes .html TS segments</h2>
  <input id="inputUrl" type="text" placeholder="Paste .m3u8 or .mpd URL"/>
  <button id="btnLoad">Load</button>
  <button id="btnPlay" disabled>Play Flattened</button>
  <div id="status" style="margin-top:6px;font-size:13px;color:var(--muted)">idle</div>
  <video id="video" controls></video>
  <div class="log" id="log"></div>
</div>

<script>
(async () => {
  const input = document.getElementById('inputUrl');
  const btnLoad = document.getElementById('btnLoad');
  const btnPlay = document.getElementById('btnPlay');
  const video = document.getElementById('video');
  const logEl = document.getElementById('log');
  const status = s => document.getElementById('status').innerText = s;
  const log = (...a)=>{logEl.textContent += a.join(' ')+'\n'; logEl.scrollTop=logEl.scrollHeight};

  shaka.polyfill.installAll();
  const player = new shaka.Player(video);
  player.addEventListener('error', e => log('Shaka error', JSON.stringify(e.detail)));

  // Intercept all segment requests: if .html, fetch manually and convert to TS blob
  const net = player.getNetworkingEngine();
  if (net) {
    net.registerScheme('http', customFetcher);
    net.registerScheme('https', customFetcher);
  }

  async function customFetcher(uri, request, requestType) {
    if (/\.html(\?|$)/i.test(uri)) {
      log('Intercepting .html segment', uri);
      const res = await fetch(uri);
      const buf = await res.arrayBuffer();
      // Force TS MIME
      return { data: buf, uri, headers: { 'content-type':'video/mp2t' } };
    }
    // fallback to default
    const res = await fetch(uri);
    const buf = await res.arrayBuffer();
    return { data: buf, uri, headers: Object.fromEntries(res.headers.entries()) };
  }

  // --- Helpers for playlist rewrite ---
  function absolutize(ref, base){ try{return new URL(ref,base).href}catch{return ref}}
  async function fetchText(u){ const r=await fetch(u); if(!r.ok) throw new Error(r.status); return r.text();}
  async function flattenM3U8(url){
    const text=await fetchText(url);
    const base=url.substring(0,url.lastIndexOf('/')+1);
    const lines=text.split(/\r?\n/);
    const out=[];
    for(const l of lines){
      if(l.trim()===''){continue;}
      if(l.startsWith('#')){out.push(l);continue;}
      let seg=absolutize(l.trim(),base);
      // rewrite .html → .ts for safety (doesn’t change actual request)
      seg=seg.replace(/\.html(\?|$)/i,'.ts$1');
      out.push(seg);
    }
    return out.join('\n');
  }

  let blobUrl=null;

  btnLoad.onclick = async ()=>{
    const u=input.value.trim();
    if(!u) return alert('Enter a URL');
    try{
      status('flattening...');
      const txt=await fetchText(u);
      if(/^#EXTM3U/m.test(txt)){
        const flat=await flattenM3U8(u);
        const blob=new Blob([flat],{type:'application/x-mpegURL'});
        blobUrl=URL.createObjectURL(blob);
        log('Flattened playlist ready:',blobUrl);
        btnPlay.disabled=false;
        status('ready');
      } else if (/<MPD/i.test(txt)){
        await player.load(u);
        status('playing DASH');
      } else {
        video.src=u; video.play();
        status('playing direct');
      }
    }catch(e){ log('ERR',e); status('error'); }
  };

  btnPlay.onclick=async ()=>{
    if(!blobUrl) return;
    try{
      await player.load(blobUrl);
      status('playing (HLS via blob)');
      log('Playing blob URL');
    }catch(e){log('Shaka load error',e);status('error');}
  };
})();
</script>
</body>
</html>
