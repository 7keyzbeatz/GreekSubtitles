<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GRMF Cast Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

<style>
html,body{margin:0;width:100%;height:100%;background:#000;font-family:Arial,sans-serif;overflow:hidden}
video{width:100%;height:100%;background:#000;object-fit:contain}
.overlay{position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.85),transparent);display:flex;flex-direction:column;justify-content:flex-end;padding:24px;opacity:0;pointer-events:none;transition:.25s}
.overlay.visible{opacity:1;pointer-events:auto}
.row{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.time{min-width:60px;text-align:center;color:#fff;font-size:12px}
.seek-wrap{flex:1;position:relative}
.seek{width:100%}
.preview{position:absolute;bottom:18px;background:#000c;color:#fff;font-size:11px;padding:3px 6px;border-radius:6px;opacity:0}
.preview.visible{opacity:1}
.controls{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
.left,.right{display:flex;gap:10px;flex-wrap:wrap}
.btn{background:#111;border:1px solid #444;border-radius:999px;color:#fff;padding:10px 16px;font-size:14px;cursor:pointer}
.focus{outline:2px solid #1e90ff}
.qmenu{position:absolute;right:24px;bottom:160px;background:#000e;border:1px solid #333;border-radius:12px;padding:8px;display:none;flex-direction:column;gap:6px}
.qitem{padding:6px 10px;border-radius:6px;color:#bbb}
.qitem.active{background:#1e90ff;color:#fff}
</style>
</head>
<body>

<video id="video" crossorigin="anonymous"></video>

<div id="overlay" class="overlay">
  <div class="row">
    <div id="cur" class="time">0:00</div>
    <div class="seek-wrap" id="seekWrap">
      <input id="seek" type="range" min="0" max="100" value="0" class="seek">
      <div id="preview" class="preview">0:00</div>
    </div>
    <div id="dur" class="time">0:00</div>
  </div>

  <div class="controls">
    <div class="left">
      <button id="bBack" class="btn">‚è™ 10s</button>
      <button id="bPlay" class="btn">‚è∏</button>
      <button id="bFwd" class="btn">10s ‚è©</button>
      <button id="bRestart" class="btn">‚ü≤</button>
    </div>
    <div class="right">
      <button id="bSubs" class="btn">Subs: On</button>
      <button id="bQuality" class="btn">Quality</button>
      <button id="bMute" class="btn">üîä</button>
    </div>
  </div>
</div>

<div id="qMenu" class="qmenu"></div>

<script>
const video=document.getElementById('video');
const overlay=document.getElementById('overlay');
const curEl=document.getElementById('cur');
const durEl=document.getElementById('dur');
const seek=document.getElementById('seek');
const seekWrap=document.getElementById('seekWrap');
const preview=document.getElementById('preview');
const bBack=document.getElementById('bBack');
const bPlay=document.getElementById('bPlay');
const bFwd=document.getElementById('bFwd');
const bRestart=document.getElementById('bRestart');
const bSubs=document.getElementById('bSubs');
const bQuality=document.getElementById('bQuality');
const bMute=document.getElementById('bMute');
const qMenu=document.getElementById('qMenu');

let hls=null,hideT=null,subsOn=true;
let qItems=[],qIndex=0,qOpen=false;
let seekMode=false;

const focusables=[bBack,bPlay,bFwd,bRestart,bSubs,bQuality,bMute];
let fIndex=-1;

function fmt(s){if(!s||isNaN(s))return'0:00';let m=Math.floor(s/60);let ss=Math.floor(s%60).toString().padStart(2,'0');return `${m}:${ss}`}

function showUI(){
 overlay.classList.add('visible');
 clearTimeout(hideT);
 hideT=setTimeout(()=>{overlay.classList.remove('visible');clearFocus();},3500);
}

function clearFocus(){focusables.forEach(b=>b.classList.remove('focus'));fIndex=-1}
function setFocus(i){
 focusables.forEach(b=>b.classList.remove('focus'));
 if(i<0||i>=focusables.length){fIndex=-1;return;}
 fIndex=i;focusables[fIndex].classList.add('focus');
}
function moveFocus(d){
 if(fIndex==-1) fIndex=0;
 else fIndex=(fIndex+d+focusables.length)%focusables.length;
 setFocus(fIndex);
}

function reset(){
 if(hls){hls.destroy();hls=null;}
 video.pause();
 video.removeAttribute('src');
 video.load();
 video.querySelectorAll('track').forEach(t=>t.remove());
 seek.value=0;curEl.textContent='0:00';durEl.textContent='0:00';
 subsOn=true;bSubs.textContent='Subs: On';
}

function attachSubs(url){
 if(!url||!url.endsWith('.vtt'))return;
 const t=document.createElement('track');
 t.kind='subtitles';t.src=url;t.default=true;
 video.appendChild(t);
}

function loadStream(url,sub){
 reset();if(!url)return;
 if(url.includes('.m3u8')&&Hls.isSupported()){
  hls=new Hls();hls.loadSource(url);hls.attachMedia(video);
  hls.on(Hls.Events.MANIFEST_LOADED,(e,d)=>{
    qMenu.innerHTML='';qItems=[];qIndex=0;
    qItems.push({label:'AUTO',level:-1});
    d.levels.forEach((lvl,i)=>{
      const h=lvl.height||0,b=lvl.bitrate||0;
      qItems.push({label:h?`${h}p (${Math.round(b/1000)} kbps)`:`${Math.round(b/1000)} kbps`,level:i});
    });
    qItems.forEach((q,i)=>{
      const div=document.createElement('div');
      div.className='qitem';div.textContent=q.label;
      qMenu.appendChild(div);
    });
  });
  hls.on(Hls.Events.MANIFEST_PARSED,()=>{
    attachSubs(sub);video.play();showUI();
  });
 }else{
  video.src=url;attachSubs(sub);video.play();showUI();
 }
}

// UI buttons
bPlay.onclick=()=>video.paused?video.play():video.pause();
bBack.onclick=()=>video.currentTime=Math.max(0,video.currentTime-10);
bFwd.onclick=()=>video.currentTime+=10;
bRestart.onclick=()=>{video.currentTime=0;video.play()};
bMute.onclick=()=>{video.muted=!video.muted;bMute.textContent=video.muted?'üîá':'üîä'};
bSubs.onclick=()=>{
 subsOn=!subsOn;
 Array.from(video.textTracks).forEach(t=>t.mode=subsOn?'showing':'disabled');
 bSubs.textContent=subsOn?'Subs: On':'Subs: Off';
};

bQuality.onclick=()=>{
 qOpen=!qOpen;
 qMenu.style.display=qOpen?'flex':'none';
};

// time updates
video.addEventListener('timeupdate',()=>{
 if(!video.duration)return;
 seek.value=(video.currentTime/video.duration)*100;
 curEl.textContent=fmt(video.currentTime);
 durEl.textContent=fmt(video.duration);
});

// seekbar
seek.addEventListener('input',()=>{
 if(video.duration)video.currentTime=(seek.value/100)*video.duration;
});

// preview bubble
seekWrap.addEventListener('mousemove',e=>{
 if(!video.duration)return;
 const r=seekWrap.getBoundingClientRect();
 let p=(e.clientX-r.left)/r.width;
 p=Math.max(0,Math.min(1,p));
 preview.textContent=fmt(p*video.duration);
 preview.style.left=(p*100)+'%';
 preview.classList.add('visible');
});
seekWrap.addEventListener('mouseleave',()=>preview.classList.remove('visible'));

// REMOTE HANDLING FROM receiver.html
window.addEventListener('message',e=>{
 const d=e.data||{};
 if(d.type==='LOAD_STREAM') loadStream(d.url,d.subUrl);

 if(d.type==='REMOTE_KEY'){
  showUI();
  switch(d.key){
   case 'ArrowLeft': seekMode?video.currentTime-=10:moveFocus(-1);break;
   case 'ArrowRight': seekMode?video.currentTime+=10:moveFocus(1);break;
   case 'ArrowUp': seekMode=true;break;
   case 'ArrowDown': seekMode=false;break;
   case 'Enter':
    if(qOpen){
      const qi=qItems[qIndex];
      if(hls){
        if(qi.level===-1){hls.currentLevel=-1;hls.autoLevelEnabled=true;}
        else{hls.autoLevelEnabled=false;hls.currentLevel=qi.level;}
      }
      qOpen=false;qMenu.style.display='none';
    }else if(fIndex>=0){
      focusables[fIndex].click();
    }else{
      video.paused?video.play():video.pause();
    }
    break;
  }
 }
});

// Receiver interface
window.addEventListener('message',e=>{
 if(e.data.type==='LOAD_STREAM') loadStream(e.data.url,e.data.subUrl);
});
</script>

</body>
</html>
