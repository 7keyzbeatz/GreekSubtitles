<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GRMF Cast Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

<style>
html,body{
  margin:0;padding:0;
  width:100%;height:100%;
  background:#000;overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
video{
  width:100%;height:100%;
  object-fit:contain;background:#000;
}
.hud{
  position:absolute;
  left:50%;
  bottom:60px;
  transform:translateX(-50%);
  width:80%;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease;
}
.hud.show{opacity:1;}
.time-row{
  display:flex;
  justify-content:space-between;
  color:white;
  font-size:14px;
  margin-bottom:6px;
}
.bar{
  position:relative;
  height:6px;
  background:#2a2a2a;
  border-radius:999px;
  overflow:hidden;
}
.fill{
  position:absolute;
  top:0;left:0;height:100%;
  width:0%;
  background:#FFD600;
  box-shadow:0 0 12px rgba(255,214,0,.7);
  transition:width .08s linear;
}
.log{
  position:absolute;
  bottom:0;
  width:100%;
  max-height:35%;
  overflow:auto;
  background:rgba(0,0,0,.7);
  color:#0f0;
  font-size:11px;
  padding:4px;
}
</style>
</head>

<body>

<video id="video" crossorigin="anonymous"></video>

<div id="hud" class="hud">
  <div class="time-row">
    <div id="cur">0:00</div>
    <div id="dur">0:00</div>
  </div>
  <div class="bar"><div id="fill" class="fill"></div></div>
</div>

<div id="logs" class="log"></div>

<script>
const v = document.getElementById("video");
const hud = document.getElementById("hud");
const fill = document.getElementById("fill");
const cur = document.getElementById("cur");
const dur = document.getElementById("dur");
const logs = document.getElementById("logs");

let hls = null;
let dash = null;
let customHeaders = {};
let fatalCount = 0;
let lastTime = 0;
let currentUrl = "";
let currentSub = "";

function log(t){
  const l = document.createElement("div");
  l.textContent = "["+new Date().toLocaleTimeString()+"] "+t;
  logs.appendChild(l);
  logs.scrollTop = logs.scrollHeight;
  console.log(t);
}

function fmt(t){
  if(!isFinite(t)) return "0:00";
  t = Math.floor(t);
  const h = Math.floor(t/3600);
  const m = Math.floor((t%3600)/60);
  const s = t%60;
  return h>0
    ? `${h}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`
    : `${m}:${s.toString().padStart(2,"0")}`;
}

function showHud(){
  hud.classList.add("show");
  setTimeout(()=>hud.classList.remove("show"),3000);
}

function reset(){
  if(hls){hls.destroy();hls=null;}
  if(dash){dash.reset();dash=null;}
  v.pause(); v.src=""; v.load();
  [...v.querySelectorAll("track")].forEach(t=>t.remove());
  fatalCount=0;
}

function addSubs(url){
  if(!url) return;
  const t = document.createElement("track");
  t.kind="subtitles";
  t.src=url;
  t.default=true;
  t.srclang="en";
  v.appendChild(t);
  v.addEventListener("loadedmetadata",()=>{
    [...v.textTracks].forEach(tt=>tt.mode="showing");
  },{once:true});
}

function loadStream(url, subUrl, headers = {}){
  reset();
  currentUrl=url;
  currentSub=subUrl;
  customHeaders=headers;

  log("Loading: "+url);

  if(url.toLowerCase().includes(".m3u8") && Hls.isSupported()){
    hls = new Hls({
      xhrSetup: function(xhr){
        for(const k in customHeaders){
          xhr.setRequestHeader(k, customHeaders[k]);
        }
      }
    });

    hls.on(Hls.Events.ERROR,(e,d)=>{
      log("HLS ERROR: "+d.type+" fatal="+d.fatal);
      if(d.fatal){
        fatalCount++;
        if(fatalCount>=3) skipAhead();
        else try{hls.recoverMediaError()}catch(_){}
      }
    });

    hls.attachMedia(v);
    hls.loadSource(url);

    hls.on(Hls.Events.MANIFEST_PARSED,()=>{
      log("Manifest OK");
      addSubs(subUrl);
      v.play().catch(()=>{});
      showHud();
    });
  }
  else if(url.toLowerCase().includes(".mpd")){
    dash = dashjs.MediaPlayer().create();
    dash.initialize(v,url,true);
    addSubs(subUrl);
    showHud();
  }
  else{
    v.src=url;
    addSubs(subUrl);
    v.play().catch(()=>{});
    showHud();
  }
}

function skipAhead(){
  fatalCount=0;
  const target=(v.currentTime||lastTime)+30;
  log("SKIP +30s → "+target.toFixed(1));
  try{v.currentTime=target;}catch{}
}

v.addEventListener("timeupdate",()=>{
  if(!isFinite(v.duration)) return;
  fill.style.width=((v.currentTime/v.duration)*100)+"%";
  cur.textContent=fmt(v.currentTime);
  dur.textContent=fmt(v.duration);
  lastTime=v.currentTime;
});

setInterval(()=>{
  if(!v.src||!v.duration) return;
  if(!v.paused && Math.abs(v.currentTime-lastTime)<0.05){
    log("Freeze → reload");
    const src=v.currentSrc||currentUrl;
    const t=v.currentTime;
    v.src=src; v.load();
    v.onloadedmetadata=()=>{
      v.currentTime=t;
      v.play().catch(()=>{});
    };
  }
  lastTime=v.currentTime;
},4000);

// Remote
function remote(key){
  showHud();
  if(key==="ArrowLeft")  v.currentTime-=10;
  if(key==="ArrowRight") v.currentTime+=10;
  if(key==="Enter"||key==="MediaPlayPause") v.paused?v.play():v.pause();
}

window.addEventListener("message",(e)=>{
  const d=e.data||{};
  if(d.type==="LOAD_STREAM"){
    loadStream(d.url,d.subUrl,d.headers||{});
  }
  if(d.type==="REMOTE_KEY"){
    remote(d.key);
  }
});

document.addEventListener("keydown",(e)=>remote(e.key));
</script>

</body>
</html>
