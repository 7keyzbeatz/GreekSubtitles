<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GRMF Cast Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
<script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

<style>
html,body{
  margin:0;padding:0;
  width:100%;height:100%;
  background:#000;overflow:hidden;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

video{
  width:100%;height:100%;
  object-fit:contain;background:#000;
}

/* HUD CENTERED */
.hud{
  position:absolute;
  left:50%;
  bottom:60px;
  transform:translateX(-50%);
  width:80%;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s ease;
}

.hud.show{
  opacity:1;
  pointer-events:auto;
}

.time-row{
  display:flex;
  justify-content:space-between;
  color:white;
  font-size:14px;
  margin-bottom:6px;
}

.bar{
  position:relative;
  height:6px;
  background:#2a2a2a;
  border-radius:999px;
  overflow:hidden;
}

.fill{
  position:absolute;
  top:0;left:0;height:100%;
  width:0%;
  background:#FFD600;
  box-shadow:0 0 12px rgba(255,214,0,.7);
  transition:width .08s linear;
}

/* preview bubble (œéœÅŒ± ŒºœåŒΩŒø, ŒºœÄŒøœÅŒµŒØœÇ ŒΩŒ± Œ≤Œ¨ŒªŒµŒπœÇ thumbnails ŒºŒµœÑŒ¨) */
.preview{
  position:absolute;
  bottom:18px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.85);
  color:white;
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  opacity:0;
  pointer-events:none;
  transition:.15s;
}
.preview.show{opacity:1;}
</style>
</head>
<body>

<video id="video" crossorigin="anonymous"></video>

<div id="hud" class="hud">
  <div class="time-row">
    <div id="cur">0:00</div>
    <div id="dur">0:00</div>
  </div>
  <div class="bar" id="bar">
    <div id="fill" class="fill"></div>
    <div id="preview" class="preview">0:00</div>
  </div>
</div>

<script>
const v = document.getElementById("video");
const hud = document.getElementById("hud");
const fill = document.getElementById("fill");
const cur = document.getElementById("cur");
const dur = document.getElementById("dur");
const bar = document.getElementById("bar");
const preview = document.getElementById("preview");

let hls = null;
let dash = null;
let hudTimer = null;

let fatalCount = 0;
let lastTime = 0;
let currentUrl = "";
let currentSub = "";

function log(...args){
  console.log("[GRMF]", ...args);
}

function fmt(t){
  if(!isFinite(t)) return "0:00";
  t = Math.floor(t);
  const h = Math.floor(t/3600);
  const m = Math.floor((t%3600)/60);
  const s = t%60;
  return h>0
    ? `${h}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`
    : `${m}:${s.toString().padStart(2,"0")}`;
}

function showHud(){
  hud.classList.add("show");
  clearTimeout(hudTimer);
  hudTimer = setTimeout(()=>hud.classList.remove("show"), 3000);
}

function reset(){
  if(hls){hls.destroy();hls=null;}
  if(dash){dash.reset();dash=null;}
  v.pause();
  v.removeAttribute("src");
  v.load();
  v.querySelectorAll("track").forEach(t=>t.remove());
  fatalCount = 0;
}

function addSubs(url){
  if(!url) return;
  const t = document.createElement("track");
  t.kind="subtitles";
  t.src=url;
  t.default=true;
  t.srclang="en";
  v.appendChild(t);

  v.addEventListener("loadedmetadata",()=>{
    for(let i=0;i<v.textTracks.length;i++){
      v.textTracks[i].mode="showing";
    }
  },{once:true});
}

function loadStream(url, subUrl){
  if(!url) return;
  reset();

  currentUrl = url;
  currentSub = subUrl;

  const low = url.toLowerCase();
  log("Loading stream:", url);

  if(low.endsWith(".m3u8") && window.Hls && Hls.isSupported()){
    hls = new Hls();

    hls.on(Hls.Events.ERROR,(e,data)=>{
      log("HLS ERROR:", data.type, "fatal="+data.fatal);

      if(data.fatal){
        fatalCount++;
        if(fatalCount >= 3){
          skipBrokenSegment();
        }else{
          try{ hls.recoverMediaError(); }catch(err){}
        }
      } else {
        fatalCount = 0;
      }
    });

    hls.loadSource(url);
    hls.attachMedia(v);

    hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
      addSubs(subUrl);
      v.play().catch(()=>{});
      showHud();
    });
  }
  else if(low.endsWith(".mpd") && window.dashjs){
    dash = dashjs.MediaPlayer().create();
    dash.initialize(v, url, true);
    addSubs(subUrl);
    showHud();
  }
  else {
    v.src = url;
    addSubs(subUrl);
    v.play().catch(()=>{});
    showHud();
  }
}

function skipBrokenSegment(){
  fatalCount = 0;

  const base = (v.currentTime || lastTime || 0);
  const target = base + 30;

  log("üî• SKIP MODE ‚Üí jump to", target);

  try{
    v.currentTime = target;
  }catch(e){
    // hard reload fallback
    const src = v.currentSrc || currentUrl;
    v.src = src;
    v.load();
    v.onloadedmetadata = ()=>{
      v.currentTime = target;
      v.play().catch(()=>{});
    };
  }
}

/* time update */
v.addEventListener("timeupdate",()=>{
  if(!isFinite(v.duration)) return;
  const p = (v.currentTime/v.duration)*100;
  fill.style.width = p+"%";
  cur.textContent = fmt(v.currentTime);
  dur.textContent = fmt(v.duration);
  lastTime = v.currentTime;
});

/* freeze watchdog */
setInterval(()=>{
  if(!v.src || !v.duration) return;

  if(!v.paused && Math.abs(v.currentTime - lastTime) < 0.01){
    log("‚ö†Ô∏è Freeze detected ‚Üí soft reload");

    const src = v.currentSrc || currentUrl;
    const t = v.currentTime;

    v.src = src;
    v.load();
    v.onloadedmetadata = ()=>{
      v.currentTime = t;
      v.play().catch(()=>{});
    };
  }

  lastTime = v.currentTime;
}, 4000);

/* Manual seek */
function seek(delta){
  if(!isFinite(v.duration)) return;
  let t = v.currentTime + delta;
  if(t<0) t=0;
  if(t>v.duration) t=v.duration;
  v.currentTime = t;

  const p = (t/v.duration);
  preview.style.left = (p*100)+"%";
  preview.textContent = fmt(t);
  preview.classList.add("show");
  showHud();
}

/* Play/Pause */
function togglePlay(){
  v.paused ? v.play().catch(()=>{}) : v.pause();
  showHud();
}

/* Stop */
function stopVideo(){
  v.pause();
  v.currentTime=0;
  fill.style.width="0%";
  cur.textContent="0:00";
  showHud();
}

/* Remote input */
function remote(key){
  showHud();
  log("REMOTE:", key);

  switch(key){
    case "ArrowLeft":
    case "MediaPreviousTrack":
    case "MediaTrackPrevious":
    case "ChannelDown":
      seek(-10);
      break;

    case "ArrowRight":
    case "MediaNextTrack":
    case "MediaTrackNext":
    case "ChannelUp":
      seek(10);
      break;

    case "Enter":
    case "MediaPlayPause":
    case " ":
      togglePlay();
      break;

    case "MediaStop":
      stopVideo();
      break;
  }
}

/* Messages from receiver */
window.addEventListener("message",(e)=>{
  const d = e.data||{};
  if(d.type==="LOAD_STREAM"){
    loadStream(d.url, d.subUrl);
  }
  if(d.type==="REMOTE_KEY"){
    remote(d.key);
  }
});

/* debug local keyboard */
document.addEventListener("keydown",(e)=>remote(e.key));
</script>
</body>
</html>
