<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GRMF Pro HLS Player - Final CAF Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

  <style>
    :root {
      --bg: #050814;
      --bg-alt: #0c1020;
      --accent: #1e90ff;
      --accent-soft: rgba(30, 144, 255, 0.15);
      --danger: #ff5252;
      --text-main: #f5f7ff;
      --text-muted: #a4a9c5;
      --radius-lg: 18px;
    }
    * { box-sizing: border-box; }
    /* Fullscreen setup */
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: system-ui; color: var(--text-main); overflow: hidden; display: flex; align-items: center; justify-content: center;
    }
    .shell { width: 100%; height: 100%; padding: 0; display: flex; align-items: center; justify-content: center; }
    .main { flex: 1; width: 100%; height: 100%; position: relative; background: #000000; }
    .video-wrapper { position: relative; width: 100%; height: 100%; background: #000; }
    video { width: 100%; height: 100%; background: #000; outline: none; }
    /* FIX: ÎšÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î¿ dummy element Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ Cast SDK */
    #cast-player-player { display: none !important; }
    /* Controls styles (Î´Î¹Î±Ï„Î·ÏÎ¿ÏÎ½Ï„Î±Î¹) */
    .pro-controls { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: flex-end; padding: 16px; background: linear-gradient(to top, rgba(0,0,0,.65), transparent 55%); pointer-events: none; opacity: 0; transition: opacity .25s ease; z-index: 30; }
    .video-wrapper:hover .pro-controls, .controls-visible .pro-controls { opacity: 1; pointer-events: auto; }
    .loading-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: var(--accent); background: rgba(0,0,0,0.7); padding: 15px 25px; border-radius: var(--radius-lg); display: none; z-index: 40; }
    .loading-indicator.visible { display: block; }
    .overlay-info { position: absolute; right: 12px; bottom: 70px; left: auto; padding: 6px 10px; border-radius: 12px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; z-index: 20; opacity: 0.5; }
    .pro-bar { height: 6px; background: rgba(255,255,255,.2); border-radius: 999px; cursor: pointer; overflow: hidden; margin-bottom: 10px; position: relative; }
    .pro-fill { height: 100%; width: 0%; background: var(--accent); }
    .pro-btn { background: rgba(0,0,0,.65); border: none; color: white; padding: 10px 14px; border-radius: 999px; font-size: 14px; cursor: pointer; transition: .15s ease; min-width: 44px; min-height: 36px; outline: none; }
    .pro-btn.focus-ring, .pro-select.focus-ring { box-shadow: 0 0 0 2px var(--accent-soft), 0 0 0 1px var(--accent); }
    .pro-select { background: rgba(0,0,0,.65); border-radius: 999px; border: 1px solid rgba(255,255,255,0.18); padding: 8px 10px; color: #fff; font-size: 12px; outline: none; min-width: 88px; appearance: menulist-button; }
    /* Log viewer for debugging (ÎºÏÏ…Ï†ÏŒ) */
    #logViewer { display: none; }
  </style>
</head>
<body>

  <div class="shell">
    <div class="main">
      <div class="video-wrapper">
        <video id="video" controls crossorigin="anonymous"></video>
        
        <div id="loadingIndicator" class="loading-indicator">
            <span id="status-label">Loading...</span>
        </div>

        <div id="cast-player-player"></div> 

        <div class="pro-controls">
          <div></div> 
          <div>
            <div class="pro-bar" id="proBar"><div class="pro-fill" id="proFill"></div><div class="pro-tooltip" id="proTooltip">00:00</div></div>
            <div class="pro-buttons">
              <div class="pro-left">
                <button class="pro-btn" id="ppBtn" tabindex="1">â–¶</button>
                <button class="pro-btn" id="rwBtn" tabindex="2">Â«10</button>
                <button class="pro-btn" id="fwBtn" tabindex="3">10Â»</button>
                <button class="pro-btn" id="subToggleBtn" disabled tabindex="4">Subs: Off</button>
              </div>
              <div class="pro-right">
                <div class="pro-time-label" id="timeLabel">00:00 / 00:00</div>
                <select class="pro-select" id="qualitySelect" disabled tabindex="5"><option value="-1">Auto</option></select>
                <button class="pro-btn" id="muteBtn" tabindex="6">ğŸ”Š</button>
              </div>
            </div>
          </div>
        </div>

        <div class="overlay-info"><span id="info-res">Resolution: -</span><span class="chip" id="info-tech">CAF</span></div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusLabel = document.getElementById('status-label'); 
    const infoTech = document.getElementById('info-tech');
    const infoRes = document.getElementById('info-res');
    // ... (Î»Î¿Î¹Ï€Î¬ controls elements) ...
    const ppBtn = document.getElementById('ppBtn');
    const rwBtn = document.getElementById('rwBtn');
    const fwBtn = document.getElementById('fwBtn');
    const muteBtn = document.getElementById('muteBtn');
    const proBar = document.getElementById('proBar');
    const proFill = document.getElementById('proFill');
    const proTooltip = document.getElementById('proTooltip');
    const timeLabel = document.getElementById('timeLabel');
    const qualitySelect = document.getElementById('qualitySelect');
    const subToggleBtn = document.getElementById('subToggleBtn');
    
    let hlsInstance = null;
    let dashInstance = null;
    // ... (Î»Î¿Î¹Ï€Î­Ï‚ Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î­Ï‚) ...
    let hlsLevels = [];
    let wakeLock = null; 

    const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';

    /* --- Core Player Functions (loadStream, setStatus, attachSubtitles, controls...) --- */
    
    function log(message, type = 'info') {
      // Î£Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Ï„ÎµÎ»Î¹ÎºÏŒ player, Ï„Î¿ log Ï€Î¬ÎµÎ¹ Î¼ÏŒÎ½Î¿ ÏƒÏ„Î·Î½ console
      console.log(`[GRMF PRO PLAYER - ${type.toUpperCase()}]`, message);
    }
    
    function setStatus(text, type = 'info') {
      statusLabel.textContent = text;
      const isLoading = (text === 'Loading' || text === 'Buffering');
      if (isLoading) { loadingIndicator.classList.add('visible'); } else { loadingIndicator.classList.remove('visible'); }
      // ... (Ï‡ÏÏ‰Î¼Î±Ï„Î¹ÏƒÎ¼ÏŒÏ‚ loading indicator) ...
    }

    function clearTracks() { /* ... */ } // (ÎšÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î±ÏÎ±Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹ Î³Î¹Î± ÏƒÏ…Î½Ï„Î¿Î¼Î¯Î± - Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î¿Î½ Ï€Î±Î»Î¹ÏŒ, Ï€Î»Î®ÏÎ·)
    function attachSubtitles(url, label) { 
        if (!url || url === 'NULL' || url.trim() === '') { clearTracks(); return; } 
        // ... (Ï€Î»Î®ÏÎ·Ï‚ Î»Î¿Î³Î¹ÎºÎ®)
    } 

    function destroyHls() { /* ... */ } // (ÎšÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î±ÏÎ±Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹ Î³Î¹Î± ÏƒÏ…Î½Ï„Î¿Î¼Î¯Î±)
    function destroyDash() { /* ... */ } // (ÎšÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î±ÏÎ±Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹ Î³Î¹Î± ÏƒÏ…Î½Ï„Î¿Î¼Î¯Î±)
    function resetQualityUI() { /* ... */ } // (ÎšÏÎ´Î¹ÎºÎ±Ï‚ Ï€Î±ÏÎ±Î»ÎµÎ¯Ï€ÎµÏ„Î±Î¹ Î³Î¹Î± ÏƒÏ…Î½Ï„Î¿Î¼Î¯Î±)

    // ÎŸ loadStream Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½ÎµÎ¹ Promise
    function loadStream(videoUrl, subUrl, subLabel) {
      return new Promise((resolve, reject) => {
        // ... (Ï€Î»Î®ÏÎ·Ï‚ Î»Î¿Î³Î¹ÎºÎ® hls.js / dash.js / native loading) ...
        // [Î£Î—ÎœÎ•Î™Î©Î£Î—: Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î±Î½Ï„Î¹ÎºÎ±Ï„Î±ÏƒÏ„Î®ÏƒÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒ Ï„Î¿ comment Î¼Îµ Ï„Î¿Î½ Ï€Î»Î®ÏÎ· ÎºÏÎ´Î¹ÎºÎ± Ï„Î·Ï‚ loadStream, ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î±Î¼Î²Î±Î½Î¿Î¼Î­Î½Ï‰Î½ Ï„Ï‰Î½ resolve/reject]

        // Î•Î´Ï Î­Î½Î± placeholder Î³Î¹Î± Î½Î± Î¼Î· ÏƒÏ€Î¬ÏƒÎµÎ¹ Î¿ ÎºÏÎ´Î¹ÎºÎ±Ï‚ Ï„Î¿Ï… Cast
        log(`Loading stream via Custom Channel: ${videoUrl}`, 'custom');
        video.src = videoUrl;
        attachSubtitles(subUrl, subLabel);
        video.load();
        video.play().then(resolve).catch((e) => { 
            log('Autoplay blocked.', 'info'); 
            reject(e); // Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚
        }); 
      });
    }

    // ... (ÏŒÎ»ÎµÏ‚ Î¿Î¹ ÏƒÏ…Î½Î±ÏÏ„Î®ÏƒÎµÎ¹Ï‚ controls: togglePlayPause, formatTime, updateTimeLabel, event listeners, keydown) ...
    // [Î£Î—ÎœÎ•Î™Î©Î£Î—: Î ÏÎ­Ï€ÎµÎ¹ Î½Î± ÏƒÏ…Î¼Ï€ÎµÏÎ¹Î»Î¬Î²ÎµÎ¹Ï‚ Î¾Î±Î½Î¬ ÎŸÎ›Î— Ï„Î· Î»Î¿Î³Î¹ÎºÎ® Ï„Ï‰Î½ controls / event listeners / keydown Ï€Î¿Ï… ÎµÎ¯Ï‡Î±Î¼Îµ Ï†Ï„Î¹Î¬Î¾ÎµÎ¹].

    /* --- CAF CAST RECEIVER INTEGRATION --- */

    window.onload = function() {
        if (window.cast && window.cast.framework) {
            
            const context = cast.framework.CastReceiverContext.getInstance();
            const playerManager = context.getPlayerManager();
            
            // --- FIXES ---
            // 1. Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ Ï„Î¿ dummy element Î³Î¹Î± Ï„Î¿Î½ player Ï„Î¿Ï… CAF
            const playbackConfig = new cast.framework.PlaybackConfig();
            playbackConfig.mediaElement = document.getElementById('cast-player-player');
            context.setPlaybackConfig(playbackConfig); 
            
            // 2. Î¥Ï€Î¿Ï‡ÏÎµÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ Player Manager Î½Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎµÎ¹ Ï„Î¿ Î´Î¹ÎºÏŒ Î¼Î±Ï‚ video tag
            playerManager.setMediaElement(video);
            
            // 3. Î‘ÎºÎ¿ÏÎ¼Îµ Ï„Î¿ Custom Message Channel
            context.addCustomMessageListener(NAMESPACE, function (event) {
                
                log('Custom Message Received! Starting custom load.', 'cast');

                try {
                    // event.data ÎµÎ¯Î½Î±Î¹ Î®Î´Î· JSON object Î±Î½ Ï„Î¿ ÏƒÏ„ÎµÎ¯Î»Î±Î¼Îµ Î¼Îµ Cast API
                    const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

                    const videoUrl = data.url;
                    const subUrl = data.subUrl; 
                    
                    if (videoUrl) {
                        // ÎšÎ±Î»Î¿ÏÎ¼Îµ Ï„Î¿Î½ Î´Î¹ÎºÏŒ Î¼Î±Ï‚ loadStream Î¼Îµ Ï„Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï… Custom Message
                        loadStream(videoUrl, subUrl, 'Greek')
                            .then(() => {
                                log('Custom Player Load SUCCESS.', 'cast');
                            })
                            .catch((e) => {
                                log(`Custom Player Load FAILED: ${e.message}`, 'error');
                            });
                    }
                } catch (e) {
                    log(`Failed to parse custom JSON: ${e.message}`, 'error');
                }
            });

            // ÎÎµÎºÎ¹Î½Î¬Î¼Îµ Ï„Î¿Î½ Context
            context.start();
            
        } else {
            log('CAF SDK not found.', 'error');
        }
    };
</script>
</body>
</html>
