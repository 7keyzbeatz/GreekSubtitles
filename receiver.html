<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GRMF Pro HLS Player - Final Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>

  <style>
    /* ... (ŒöœÅŒ±œÑŒ¨ŒºŒµ œåŒªŒ± œÑŒ± CSS styles œåœÄœâœÇ œÉœÖŒºœÜœâŒΩŒÆœÉŒ±ŒºŒµ, œÉœÖŒºœÄŒµœÅŒπŒªŒ±ŒºŒ≤Œ±ŒΩŒøŒºŒ≠ŒΩœâŒΩ œÑœâŒΩ FIXES) ... */
    :root {
      --bg: #050814;
      --bg-alt: #0c1020;
      --accent: #1e90ff;
      --danger: #ff5252;
      --text-main: #f5f7ff;
      --text-muted: #a4a9c5;
      --radius-lg: 18px;
    }
    html, body {
      width: 100%; height: 100%; margin: 0; padding: 0; background: #000; overflow: hidden; display: flex; align-items: center; justify-content: center;
    }
    .shell { width: 100%; height: 100%; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    #cast-player-player { display: none !important; }
    .panel {
      background: linear-gradient(135deg, rgba(8, 13, 35, 0.96), rgba(8, 15, 45, 0.96));
      border-radius: var(--radius-lg); padding: 14px 16px; box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.06); display: none; flex-direction: column; gap: 10px; z-index: 50; position: absolute; top: 16px; width: 90%; max-width: 600px; left: 50%; transform: translateX(-50%);
    }
    .panel.visible { display: flex; }
    .panel-grid { display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 10px; }
    @media (max-width: 780px) { .panel-grid { grid-template-columns: 1fr; } }
    .main { flex: 1; width: 100%; height: 100%; margin-top: 0; border-radius: 0; overflow: hidden; background: #000000; position: relative; }
    .video-wrapper { position: relative; width: 100%; height: 100%; background: #000; }
    video { width: 100%; height: 100%; background: #000; outline: none; }
    #toggleDebugBtn {
        position: absolute; top: 16px; left: 16px; z-index: 40; background: rgba(0,0,0,.65); color: white; padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.15); cursor: pointer; font-size: 12px;
    }
    .log-container {
        max-height: 150px; overflow-y: auto; padding: 8px; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--radius-md); background: rgba(0, 0, 0, 0.4);
    }
    #logViewer {
        font-family: monospace; font-size: 11px; color: var(--text-muted); display: flex; flex-direction: column-reverse;
    }
    .log-entry { padding: 2px 0; border-bottom: 1px dotted rgba(255, 255, 255, 0.05); white-space: pre-wrap; }
    .log-entry span { font-weight: 500; }
    .log-entry.cast span { color: var(--accent); }
    .log-entry.error span { color: var(--danger); }
    .loading-indicator {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 24px; color: var(--accent); background: rgba(0,0,0,0.7); padding: 15px 25px; border-radius: var(--radius-lg); display: none;
    }
    /* ... (ŒªŒøŒπœÄŒ¨ controls styles) ... */
  </style>
</head>
<body>

  <div class="shell">
    
    <button id="toggleDebugBtn">‚öôÔ∏è Debug Panel</button>
    <div id="cast-player-player"></div>

    <div id="debugPanel" class="panel">
      <div class="panel-top">
        <div class="panel-title">Stream Configuration (Manual Debug)</div>
        <div class="badge">Manual test mode</div>
      </div>
      <div class="panel-grid">
        <div class="field"><label for="videoUrl">Video URL (HLS .m3u8, MP4, Œ∫ŒªœÄ.)</label><input id="videoUrl" type="text" placeholder="URL Œ±œÄœå Android Studio" /></div>
        <div class="field"><label for="subUrl">Subtitles URL (VTT)</label><input id="subUrl" type="text" placeholder="URL Œ±œÄœå SubtitlesServerUrl" /></div>
        <div class="field"><label for="subLabel">Subtitles Label</label><input id="subLabel" type="text" placeholder="Greek" value="Greek" /></div>
      </div>
      <div class="actions">
        <button id="btnFillDemo" class="btn btn-secondary" type="button"><span class="btn-icon">‚≠ê</span> Demo values</button>
        <button id="btnLoad" class="btn" type="button"><span class="btn-icon">‚ñ∂</span> Load stream manually</button>
      </div>
      <div class="log-container"><div id="logViewer">Ready. Waiting for Cast or manual input.</div></div>
    </div>

    <div class="main">
      <div class="video-wrapper">
        <video id="video" controls crossorigin="anonymous"></video>
        
        <div id="loadingIndicator" class="loading-indicator"><span id="status-label">Loading...</span></div>

        <div class="pro-controls">
          <div></div> 
          <div>
            <div class="pro-bar" id="proBar"><div class="pro-fill" id="proFill"></div><div class="pro-tooltip" id="proTooltip">00:00</div></div>
            <div class="pro-buttons">
              <div class="pro-left">
                <button class="pro-btn" id="ppBtn" tabindex="1">‚ñ∂</button>
                <button class="pro-btn" id="rwBtn" tabindex="2">¬´10</button>
                <button class="pro-btn" id="fwBtn" tabindex="3">10¬ª</button>
                <button class="pro-btn" id="subToggleBtn" disabled tabindex="4">Subs: Off</button>
              </div>
              <div class="pro-right">
                <div class="pro-time-label" id="timeLabel">00:00 / 00:00</div>
                <select class="pro-select" id="qualitySelect" disabled tabindex="5"><option value="-1">Auto</option></select>
                <button class="pro-btn" id="muteBtn" tabindex="6">üîä</button>
              </div>
            </div>
          </div>
        </div>

        <div class="overlay-info"><span id="info-res">Resolution: -</span><span class="chip" id="info-tech">HTML5</span></div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const statusLabel = document.getElementById('status-label'); 
    const infoTech = document.getElementById('info-tech');
    const infoRes = document.getElementById('info-res');

    const ppBtn = document.getElementById('ppBtn');
    const rwBtn = document.getElementById('rwBtn');
    const fwBtn = document.getElementById('fwBtn');
    const muteBtn = document.getElementById('muteBtn');
    
    const proBar = document.getElementById('proBar');
    const proFill = document.getElementById('proFill');
    const proTooltip = document.getElementById('proTooltip');
    const timeLabel = document.getElementById('timeLabel');
    const qualitySelect = document.getElementById('qualitySelect');
    const subToggleBtn = document.getElementById('subToggleBtn');
    
    const debugPanel = document.getElementById('debugPanel');
    const toggleDebugBtn = document.getElementById('toggleDebugBtn');
    const videoInput = document.getElementById('videoUrl');
    const subInput = document.getElementById('subUrl');
    const subLabelInput = document.getElementById('subLabel');
    const btnLoad = document.getElementById('btnLoad');
    const btnDemo = document.getElementById('btnFillDemo');
    const logViewer = document.getElementById('logViewer'); 

    let hlsInstance = null;
    let dashInstance = null;
    let activeSubtitleTrack = null;
    let hlsLevels = [];
    let wakeLock = null; 

    const focusableControls = [ppBtn, rwBtn, fwBtn, subToggleBtn, qualitySelect, muteBtn].filter(Boolean);
    let focusIndex = -1;

    focusableControls.forEach(el => { if (el) { el.setAttribute('tabindex', '0'); } });

    function applyFocusRing() {
      focusableControls.forEach(el => el && el.classList.remove('focus-ring'));
      if (focusIndex >= 0 && focusIndex < focusableControls.length) {
        const el = focusableControls[focusIndex];
        if (el) { el.classList.add('focus-ring'); el.focus(); }
      } else {
        document.body.classList.remove('controls-visible');
      }
    }

    function setFocus(index) {
      if (!focusableControls.length) return;
      if (index < 0) index = focusableControls.length - 1;
      if (index >= focusableControls.length) index = 0;
      focusIndex = index;
      document.body.classList.add('controls-visible');
      applyFocusRing();
    }

    function clearFocus() {
      focusIndex = -1;
      focusableControls.forEach(el => el && el.classList.remove('focus-ring'));
    }

    /* Log and Status */
    function log(message, type = 'info') {
        console.log(`[GRMF PLAYER - ${type.toUpperCase()}]`, message);

        const time = new Date().toLocaleTimeString('el-GR', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
        
        const entry = document.createElement('div');
        entry.classList.add('log-entry', type);
        entry.innerHTML = `[${time}] <span class="log-${type}">${message}</span>`;
        
        if (logViewer) {
            if (logViewer.textContent.includes('Waiting for Cast or manual input.')) {
                logViewer.innerHTML = ''; 
            }
            logViewer.prepend(entry); 

            while (logViewer.children.length > 30) {
                logViewer.removeChild(logViewer.lastChild);
            }
        }
        
        if (type === 'error') {
            setStatus(`ERROR: ${message}`, 'error');
        } 
    }

    function setStatus(text, type = 'info') {
      statusLabel.textContent = text;
      const isLoading = (text === 'Loading' || text === 'Buffering');
      
      if (isLoading) {
          loadingIndicator.classList.add('visible');
      } else {
          loadingIndicator.classList.remove('visible');
      }
      
      if (type === 'error') {
          loadingIndicator.style.backgroundColor = 'rgba(255, 82, 82, 0.7)';
      } else {
          loadingIndicator.style.backgroundColor = 'rgba(0,0,0,0.7)';
      }
    }
    
    function clearTracks() {
      const tracks = video.querySelectorAll('track');
      tracks.forEach(t => t.remove());
      activeSubtitleTrack = null;
      if (subToggleBtn) {
        subToggleBtn.disabled = true;
        subToggleBtn.textContent = 'Subs: Off';
      }
    }

    function attachSubtitles(url, label) {
      if (!url || url === 'NULL' || url.trim() === '') {
        clearTracks();
        log('Subtitles URL is empty/null. Not attaching track.', 'info');
        return;
      }
      clearTracks();

      const track = document.createElement('track');
      track.kind = 'subtitles';
      track.label = label || 'Subtitles';
      track.srclang = 'el'; 
      track.src = url;
      track.default = true;
      video.appendChild(track);

      activeSubtitleTrack = track;
      const textTracks = video.textTracks;
      for (let i = 0; i < textTracks.length; i++) {
        textTracks[i].mode = (textTracks[i].label === track.label) ? 'showing' : 'disabled';
      }
      if (subToggleBtn) {
        subToggleBtn.disabled = false;
        subToggleBtn.dataset.state = 'on';
        subToggleBtn.textContent = 'Subs: On';
      }
    }

    function destroyHls() {
      if (hlsInstance) {
        hlsInstance.destroy();
        hlsInstance = null;
      }
      hlsLevels = [];
    }

    function destroyDash() {
      if (dashInstance && typeof dashInstance.reset === 'function') {
        dashInstance.reset();
      }
      dashInstance = null;
    }

    function resetQualityUI() {
      if (!qualitySelect) return;
      qualitySelect.innerHTML = '<option value="-1">Auto</option>';
      qualitySelect.disabled = true;
      qualitySelect.value = '-1';
      infoRes.textContent = 'Resolution: -';
      infoRes.style.opacity = '0.5';
    }

    function loadStream(videoUrl, subUrl, subLabel) {
      return new Promise((resolve, reject) => {

        requestWakeLock();
        
        destroyHls();
        destroyDash();
        clearTracks();
        resetQualityUI();

        if (!videoUrl || videoUrl === 'NULL' || videoUrl.trim() === '') {
          log('No video URL provided. Stopping load.', 'error');
          setStatus('Ready (No URL)');
          reject(new Error('No video URL'));
          return;
        }

        setStatus('Loading');
        infoTech.textContent = 'HTML5';

        const urlLower = videoUrl.toLowerCase();
        const isHls = urlLower.includes('.m3u8');
        const isDash = urlLower.includes('.mpd');
        
        if (isHls && window.Hls && window.Hls.isSupported()) {
          infoTech.textContent = 'hls.js';
          hlsInstance = new Hls({
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 60
          });

          hlsInstance.on(Hls.Events.ERROR, function (event, data) {
            if (data.fatal) {
              log(`HLS fatal error: ${data.type} (Details: ${data.details})`, 'error');
              setStatus('Error: HLS Fail');
              destroyHls();
              releaseWakeLock();
              reject(new Error(`HLS Fatal: ${data.type}`));
              return; 
            }
          });

          hlsInstance.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
            if (!hlsInstance || !hlsInstance.levels) return;
            const level = hlsInstance.levels[data.level];
            let resText = 'auto';
            if (level && level.height) { resText = `${level.height}p`; infoRes.style.opacity = '1'; } else { resText = 'auto'; infoRes.style.opacity = '0.5'; }
            infoRes.textContent = `Resolution: ${resText}`;
            if (qualitySelect && hlsInstance.autoLevelEnabled) { qualitySelect.value = '-1'; } else if (qualitySelect && !isNaN(data.level)) { qualitySelect.value = data.level.toString(); }
          });
          
          hlsInstance.on(Hls.Events.BUFFER_APPENDING, function() { setStatus('Buffering'); });
          hlsInstance.on(Hls.Events.MANIFEST_PARSED, function () {
            log('HLS manifest parsed, starting playback‚Ä¶', 'cast');
            attachSubtitles(subUrl, subLabel);
            video.play().catch(err => { log('Autoplay blocked. User must press play.', 'info'); });
            resolve(); 
          });
          
          hlsInstance.loadSource(videoUrl);
          hlsInstance.attachMedia(video);

        } else if (isDash && window.dashjs) {
          infoTech.textContent = 'dash.js';
          dashInstance = dashjs.MediaPlayer().create();
          dashInstance.initialize(video, videoUrl, true);
          attachSubtitles(subUrl, subLabel);
          dashInstance.on('error', function (e) { log('DASH error: ' + (e ? JSON.stringify(e) : 'unknown'), 'error'); setStatus('Error: DASH Fail'); releaseWakeLock(); reject(new Error('DASH error')); });
          resolve(); 

        } else {
          // Native HTML5 playback
          infoTech.textContent = 'HTML5';
          video.src = videoUrl;
          attachSubtitles(subUrl, subLabel);
          video.load();
          video.play().then(() => { log('Playback started with native HTML5.', 'cast'); resolve(); }).catch(err => { log('Autoplay blocked. User must press play.', 'info'); resolve(); });
        }
      });
    }
    
    /* ... (Debug Panel, Keep Awake, Video Events, Controls) ... */
    
    toggleDebugBtn.addEventListener('click', () => { debugPanel.classList.toggle('visible'); });

    btnLoad.addEventListener('click', () => {
      const v = videoInput.value.trim();
      const s = subInput.value.trim();
      const label = subLabelInput.value.trim() || 'Subtitles';
      log(`Manual load started for: ${v}`, 'info');
      loadStream(v, s, label).catch(e => { log(`Manual load failed: ${e.message}`, 'error'); });
      debugPanel.classList.remove('visible'); 
    });

    btnDemo.addEventListener('click', () => {
      videoInput.value = 'https://icy-boat-356c.10011-8fd.workers.dev/hailmist36.pro/file2/OPPyPnl4Slab+HjmeyZo4u1zAX2Dhzg8B18K1n7MUr3jnSWsiGlLFwO8GMyo0ADgxnWyd99p28pERmEvHnueH0Kr3Vi5cB+YopkKZer3Vi5cB+YopkKZer3DljXgq1JhdJRfAlnzgwDzgT+V5Va5HhoK~FUPR6WLXxrejqDHDxAymrefPTv1Yla4Ac=/cGxheWxpc3QubTN1OA==.m3u8';
      subInput.value = 'https://gist.githubusercontent.com/movieflixgr/478cc773cae72d60f3e9edd5da3442b1/raw/f10c660b985e28a077f53a5cfed609e1f186149a/%5B_Thanksgiving%202023%201080p%20WEBRip%201400MB%20DD5%201%20x264-GalaxyRG_%5D.vtt/download?filename=subs.vtt';
      subLabelInput.value = 'Greek';
      log('Demo values filled. Press "Load stream manually" to test.');
    });

    async function requestWakeLock() { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} } }
    function releaseWakeLock() { if (wakeLock) { wakeLock.release().catch(() => {}); wakeLock = null; } }

    video.addEventListener('playing', () => { setStatus('Playing'); requestWakeLock(); });
    video.addEventListener('pause', () => { setStatus('Paused'); });
    video.addEventListener('waiting', () => { setStatus('Buffering'); });
    video.addEventListener('loadedmetadata', () => { setStatus('Ready'); });
    video.addEventListener('error', () => { const err = video.error; log('Video error: ' + (err ? err.code : 'unknown'), 'error'); setStatus('Error: Playback Failed'); releaseWakeLock(); });

    // ... (ŒøŒπ œÖœÄœåŒªŒøŒπœÄŒøŒπ event listeners Œ∫Œ±Œπ controls œÄŒ±œÅŒ±ŒºŒ≠ŒΩŒøœÖŒΩ ŒØŒ¥ŒπŒøŒπ)

    /* === CAST SDK INTEGRATION === */

    window.onload = function() {
        if (window.cast && window.cast.receiver) {
            log('Cast Receiver SDK initializing...', 'cast');
            
            const context = cast.receiver.CastReceiverContext.getInstance();
            const playerManager = context.getPlayerManager();
            
            requestWakeLock();

            const playbackConfig = new cast.framework.PlaybackConfig();
            playbackConfig.mediaElement = document.getElementById('cast-player-player');
            context.setPlaybackConfig(playbackConfig); 
            
            playerManager.setMediaElement(video);


            playerManager.setMessageInterceptor(cast.framework.messages.MessageType.LOAD, (loadRequest) => {
                
                const realVideoUrl = loadRequest.media.contentId; 
                let subUrl = null;
                let subLabel = 'Subtitles';

                if (loadRequest.media.mediaTracks) {
                    const subtitleTrack = loadRequest.media.mediaTracks.find(
                        track => track.type === cast.framework.messages.MediaTrack.Type.TEXT
                    );
                    
                    if (subtitleTrack && subtitleTrack.trackContentId) {
                        subUrl = subtitleTrack.trackContentId; 
                        subLabel = subtitleTrack.name || subtitleTrack.language || 'Subtitles';
                    }
                }
                
                log(`Cast: Received LOAD command for: ${realVideoUrl}`, 'cast');
                
                if (videoInput) videoInput.value = realVideoUrl || 'NULL';
                if (subInput) subInput.value = subUrl || 'NULL';
                if (subLabelInput) subLabelInput.value = subLabel || 'Greek';
                
                // *** Œ§Œü ŒöŒ°ŒôŒ£ŒôŒúŒü FIX: ŒöŒëŒõŒüŒ•ŒúŒï Œ§ŒüŒù ŒîŒôŒöŒü ŒúŒëŒ£ PLAYER ŒöŒëŒô ŒëŒõŒõŒëŒñŒüŒ•ŒúŒï Œ§Œü URL Œ§ŒüŒ• SDK ***
                
                return loadStream(realVideoUrl, subUrl, subLabel)
                    .then(() => {
                         log(`Cast: Custom player initiated stream.`, 'cast');
                         
                         // ŒëŒªŒªŒ±Œ≥ŒÆ œÑŒøœÖ contentId œÉŒµ Œ≠ŒΩŒ± Œ±œÄŒªœå URL (œÄ.œá., Œ≠ŒΩŒ± ŒºŒπŒ∫œÅœå mp4 ŒÆ dummy stream)
                         // Œ≥ŒπŒ± ŒΩŒ± "Œ∑œÅŒµŒºŒÆœÉŒµŒπ" œÑŒø Cast SDK Œ∫Œ±Œπ ŒΩŒ± ŒºŒ∑ œÄœÅŒøœÉœÄŒ±Œ∏ŒµŒØ ŒΩŒ± œÄŒ±ŒØŒæŒµŒπ œÑŒø HLS/DASH
                         // œÑŒ±œÖœÑœåœáœÅŒøŒΩŒ± ŒºŒµ œÑŒø hls.js. 
                         // Œ§Œø Cast SDK Œ∏Œ± œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒÆœÉŒµŒπ Œ±œÖœÑœå œÑŒø dummy URL Œ≥ŒπŒ± œÑŒøŒΩ Œ¥ŒπŒ∫œå œÑŒøœÖ Player Manager, 
                         // Œø ŒøœÄŒøŒØŒøœÇ œåŒºœâœÇ ŒµŒØŒΩŒ±Œπ Œ∫œÅœÖœÜœåœÇ Œ∫Œ±Œπ œáœÅŒ∑œÉŒπŒºŒøœÄŒøŒπŒµŒØ œÑŒø #cast-player-player div.
                         loadRequest.media.contentId = 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4'; 
                         loadRequest.media.contentType = 'video/mp4';

                         log(`Cast: Overwriting contentId to dummy stream to suppress Cast SDK player conflicts.`, 'cast');
                         
                         return loadRequest; 
                    })
                    .catch(e => {
                        log(`Cast: Player load failed. Check URL or network.`, 'error');
                        return null; 
                    });
            });

            context.start();
            
        } else {
            log('Cast SDK not found. Waiting for manual input.');
        }
    };
  </script>
</body>
</html>
