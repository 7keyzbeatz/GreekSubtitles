<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GRMF Hybrid Cast Receiver</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CAF SDK -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <!-- hls.js for browser fallback -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

    <style>
        html, body {
            background: black;
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        video {
            width: 100%;
            height: 100%;
            background: black;
        }

        #debug {
            position: fixed;
            left: 10px;
            top: 10px;
            background: rgba(0,0,0,0.7);
            color: #00ffcc;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            max-width: 90%;
            white-space: pre-wrap;
            word-break: break-all;
            z-index: 9999;
        }
    </style>
</head>
<body>

<div id="debug">Waiting for cast data...</div>
<video id="video" controls crossorigin="anonymous"></video>

<script>
    const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';
    const debug = document.getElementById('debug');
    const video = document.getElementById('video');

    let hls = null;
    let isCast = false;

    function log(msg) {
        debug.textContent = msg;
        console.log(msg);
    }

    // Detect Chromecast environment
    try {
        isCast = !!(window.cast && cast.framework);
    } catch (e) {
        isCast = false;
    }

    log('Mode: ' + (isCast ? 'Chromecast CAF' : 'Browser HTML5'));

    // --------- Browser / hls.js mode ----------
    function playInBrowser(url, subUrl) {
        if (hls) {
            hls.destroy();
            hls = null;
        }

        while (video.firstChild) {
            video.removeChild(video.firstChild);
        }

        if (Hls.isSupported() && url.includes('.m3u8')) {
            hls = new Hls();
            hls.attachMedia(video);
            hls.loadSource(url);
        } else {
            video.src = url;
        }

        if (subUrl && subUrl.endsWith('.vtt')) {
            const track = document.createElement('track');
            track.kind = 'subtitles';
            track.src = subUrl;
            track.default = true;
            video.appendChild(track);
        }

        video.play().catch(()=>{});
    }

    // --------- Chromecast CAF mode ----------
    function playInCast(url, subUrl) {
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        const mediaInfo = new cast.framework.messages.MediaInformation(url);
        mediaInfo.contentType = 'application/x-mpegURL';
        mediaInfo.streamType = cast.framework.messages.StreamType.BUFFERED;

        let hasSubs = false;

        if (subUrl && subUrl.endsWith('.vtt')) {
            const track = new cast.framework.messages.Track(
                1,
                cast.framework.messages.TrackType.TEXT
            );
            track.trackContentId = subUrl;
            track.trackContentType = 'text/vtt';
            track.subtype = cast.framework.messages.TextTrackType.SUBTITLES;
            track.name = 'Subtitles';
            track.language = 'en';

            mediaInfo.tracks = [track];
            hasSubs = true;
        }

        const request = new cast.framework.messages.LoadRequestData();
        request.media = mediaInfo;
        request.autoplay = true;

        if (hasSubs) {
            // IMPORTANT: do not force preload before video
            setTimeout(() => {
                try {
                    playerManager.setActiveTrackIds([1]);
                    log('Subtitles enabled safely âœ…');
                } catch(e){}
            }, 1500);
        }

        playerManager.load(request);
    }

    // --------- Message listener ----------
    function handleMessage(data) {
        const videoUrl = data.url || '';
        const subUrl = data.subUrl || '';

        log('VIDEO:\n' + videoUrl + '\n\nSUB:\n' + subUrl);

        if (!videoUrl) return;

        if (isCast) {
            playInCast(videoUrl, subUrl);
        } else {
            playInBrowser(videoUrl, subUrl);
        }
    }

    // CAF only: listen for sender messages
    if (isCast) {
        const context = cast.framework.CastReceiverContext.getInstance();

        context.addCustomMessageListener(NAMESPACE, function(event) {
            try {
                const data = typeof event.data === 'string'
                    ? JSON.parse(event.data)
                    : event.data;

                handleMessage(data);
            } catch (e) {
                log('JSON error: ' + e.message);
            }
        });

        context.start();
    }

    // Browser manual test
    if (!isCast) {
        log('Open console and run:\nplayTest(url, subUrl)');
        window.playTest = (url, sub) => handleMessage({url, subUrl: sub});
    }
</script>

</body>
</html>
