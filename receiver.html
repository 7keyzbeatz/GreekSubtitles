<script>
/* ===============================
   Î’Î‘Î£Î™ÎšÎ‘ ELEMENTS
================================== */
const video    = document.getElementById("video");
const playBtn  = document.getElementById("play");
const rwBtn    = document.getElementById("rewind");
const fwBtn    = document.getElementById("forward");
const muteBtn  = document.getElementById("mute");
const subsBtn  = document.getElementById("subs");

const bar      = document.getElementById("bar");
const fill     = document.getElementById("fill");
const quality  = document.getElementById("quality");

const resEl    = document.getElementById("res");
const techEl   = document.getElementById("tech");
const statusEl = document.getElementById("status");

// ÎÎ­Î± Î»Î¯ÏƒÏ„Î± Î¼Îµ ÏŒÎ»Î± Ï„Î± controls Ï€Î¿Ï… Î¸Î­Î»Î¿Ï…Î¼Îµ Î½Î± ÎµÎ¯Î½Î±Î¹ focusable
const focusableControls = [
  playBtn, rwBtn, fwBtn, subsBtn, quality, muteBtn
];

let hls = null;
let currentSubTrack = null;
let controlsTimeout; // Î“Î¹Î± Î½Î± ÎºÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î± controls Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î±
const isTV = /TV|BRAVIA|AFT|Android TV/i.test(navigator.userAgent);

/* ===============================
   CAST RECEIVER SETUP
================================== */
const context       = cast.framework.CastReceiverContext.getInstance();
const playerManager = context.getPlayerManager();

// ÎœÎ—Î ÎºÎ¬Î½ÎµÎ¹ idle timeout Î¿ receiver
context.setInactivityTimeout(0);

/**
 * ÎšÎ±Î»ÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î±Î½ Î¿ sender ÎºÎ¬Î½ÎµÎ¹ LOAD (RemoteMediaClient.load(getMediaInfo()))
 * ÎµÎ´Ï Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ:
 * - media.contentId  => video URL (Î±Ï€ÏŒ VideoCast)
 * - media.tracks[]   => subtitles (SubtitlesServerUrl)
 */
playerManager.setMessageInterceptor(
  cast.framework.messages.MessageType.LOAD,
  (loadRequestData) => {
    const media = loadRequestData.media;
    if (!media) return null;

    const videoUrl = media.contentId;
    let subtitleUrl = null;
    let subtitleLang = "Subtitles";

    if (Array.isArray(media.tracks)) {
      const textTrack =
        media.tracks.find(t => t.type === "TEXT" || t.type === 1) || null;

      if (textTrack) {
        // Î‘Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· SDK, Ï„Î¿ URL ÎµÎ¯Î½Î±Î¹ ÎµÎ¯Ï„Îµ trackContentId ÎµÎ¯Ï„Îµ contentId
        subtitleUrl  = textTrack.trackContentId || textTrack.contentId || null;
        subtitleLang = textTrack.language || textTrack.name || "Subtitles";
      }
    }

    statusEl.textContent = "Loading from sender...";
    techEl.textContent   = "Preparing";

    loadPlayer(videoUrl, subtitleUrl, subtitleLang);

    // Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î¼Îµ null Î³Î¹Î± Î½Î± ÎœÎ—Î ÎºÎ¬Î½ÎµÎ¹ auto-load Î¿ default CAF player
    return null;
  }
);

// Î£Ï…Î½Î´Î­Î¿Ï…Î¼Îµ Play/Pause/Seek Î±Ï€ÏŒ Ï„Î¿Î½ sender ÏƒÏ„Î¿ Î´Î¹ÎºÏŒ Î¼Î±Ï‚ <video>
playerManager.addEventListener(
  cast.framework.events.EventType.PLAY,
  () => {
    video.play().catch(() => {});
  }
);

playerManager.addEventListener(
  cast.framework.events.EventType.PAUSE,
  () => {
    video.pause();
  }
);

playerManager.addEventListener(
  cast.framework.events.EventType.SEEKING,
  (e) => {
    if (!isNaN(e.currentTime)) {
      video.currentTime = e.currentTime;
    }
  }
);

// Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· receiver
context.start();

/* ===============================
   PLAYER LOADER (Î§Î©Î¡Î™Î£ HARDCODED URLs)
================================== */
function destroyHls() {
  if (hls) {
    hls.destroy();
    hls = null;
  }
}

function clearSubtitles() {
  const tracks = video.querySelectorAll("track");
  tracks.forEach(t => t.remove());
  currentSubTrack = null;
  subsBtn.disabled = true;
}

function attachSubtitles(subUrl, subLang) {
  clearSubtitles();
  if (!subUrl) return;

  const track = document.createElement("track");
  track.kind = "subtitles";
  track.label = subLang || "Subtitles";
  track.srclang = "el";
  track.src = subUrl;
  track.default = true;
  video.appendChild(track);

  if (video.textTracks && video.textTracks.length > 0) {
    video.textTracks[0].mode = "showing";
  }

  subsBtn.disabled = false;
  currentSubTrack = track;
}

function loadPlayer(videoUrl, subUrl, subLang) {
  destroyHls();
  clearSubtitles();

  if (!videoUrl) {
    statusEl.textContent = "No media URL received";
    techEl.textContent = "Error";
    return;
  }

  statusEl.textContent = "Loading...";
  techEl.textContent = "HTML5";

  if (videoUrl.includes(".m3u8") && Hls.isSupported()) {
    techEl.textContent = "hls.js";
    hls = new Hls({
      enableWorker: true,
      lowLatencyMode: true,
      backBufferLength: 90
    });

    hls.loadSource(videoUrl);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      statusEl.textContent = "Playing";
      video.play().catch(() => {});
      attachSubtitles(subUrl, subLang);
    });

    // Î“ÎµÎ¼Î¯Î¶Î¿Ï…Î¼Îµ Ï€Î¿Î¹ÏŒÏ„Î·Ï„ÎµÏ‚ Î¼Îµ Î±Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î® (ÏÏƒÏ„Îµ Î½Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½ Î¼Îµ Ï„Î± indexes)
    hls.on(Hls.Events.MANIFEST_LOADED, (_, d) => {
      quality.innerHTML = '<option value="-1">Auto</option>';

      const reversed = d.levels
        .map((lvl, i) => ({ lvl, i }))
        .reverse();

      reversed.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.i; // Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ HLS index
        opt.textContent = item.lvl.height
          ? item.lvl.height + "p"
          : "Level";
        quality.appendChild(opt);
      });

      quality.disabled = false;
    });

    hls.on(Hls.Events.LEVEL_SWITCHED, (_, d) => {
      const level = hls.levels[d.level];
      resEl.textContent = level && level.height
        ? "Resolution: " + level.height + "p"
        : "Resolution: auto";
    });

  } else {
    video.src = videoUrl;
    video.play().catch(() => {});
    statusEl.textContent = "Playing (native)";
    attachSubtitles(subUrl, subLang);
  }

  // Keep-alive Î³Î¹Î± Î½Î± Î¼Î· Î¸ÎµÏ‰ÏÎ·Î¸ÎµÎ¯ idle
  setInterval(() => {
    if (!video.paused && !video.ended) {
      // Î‘Ï€Î»ÏŒ touch ÏƒÏ„Î¿ currentTime ÏÏƒÏ„Îµ Ï„Î¿ runtime Î½Î± Î¼Î·Î½ ÎºÎ¿Î¹Î¼Î·Î¸ÎµÎ¯
      video.currentTime = video.currentTime;
    }
  }, 15000);
}

/* ===============================
   HELPER FUNCTIONS Î“Î™Î‘ CONTROLS
================================== */
// Î•Î¼Ï†Î±Î½Î¯Î¶ÎµÎ¹ Ï„Î± controls ÎºÎ±Î¹ Î¾ÎµÎºÎ¹Î½Î¬ÎµÎ¹ Ï„Î¿ timeout Î³Î¹Î± Î½Î± ÎºÏÏ…Ï†Ï„Î¿ÏÎ½
function showControls(focusElement = null) {
  clearTimeout(controlsTimeout);
  document.body.classList.add("show-controls");

  if (focusElement) {
    focusElement.focus();
  } else if (!document.activeElement || document.activeElement === document.body) {
    // Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ focus, ÎµÏƒÏ„Î¯Î±ÏƒÎµ ÏƒÏ„Î¿ playBtn (Ï„Î¿ default)
    playBtn.focus();
  }

  // ÎšÏÏÏˆÎµ Î¼ÎµÏ„Î¬ Î±Ï€ÏŒ 5 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± Î±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î´ÏÎ±ÏƒÏ„Î·ÏÎ¹ÏŒÏ„Î·Ï„Î±
  controlsTimeout = setTimeout(() => {
    document.body.classList.remove("show-controls");
  }, isTV ? 8000 : 3000); // Î”ÏÏƒÎµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ¿ Ï‡ÏÏŒÎ½Î¿ ÏƒÏ„Î·Î½ TV
}

// ÎšÏÏÎ²ÎµÎ¹ Ï„Î± controls Î¬Î¼ÎµÏƒÎ±
function hideControls() {
  clearTimeout(controlsTimeout);
  document.body.classList.remove("show-controls");
}


/* ===============================
   LOCAL CONTROLS (REMOTE + TV)
================================== */
// 1. ÎšÎ¬Î½Î¿Ï…Î¼Îµ ÏŒÎ»Î± Ï„Î± controls focusable
focusableControls.forEach(el => {
  el.setAttribute("tabindex", "0");
  el.addEventListener("focus", () => showControls(el)); // ÎšÏÎ±Ï„Î¬Î¼Îµ Ï„Î± controls Î±Î½Î¿Î¹Ï‡Ï„Î¬ ÏŒÏƒÎ¿ ÎºÎ¬Ï„Î¹ Î­Ï‡ÎµÎ¹ focus
});

// 2. Click/Action Handlers
playBtn.onclick = () => {
  video.paused ? video.play() : video.pause();
  showControls(playBtn); // Î•Ï€Î±Î½ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼ÎµÏ„Î¬ Ï„Î·Î½ Î±Î»Î»Î±Î³Î®
};
rwBtn.onclick   = () => {
  video.currentTime = Math.max(0, video.currentTime - 10);
  showControls(rwBtn);
};
fwBtn.onclick   = () => {
  video.currentTime = video.currentTime + 10;
  showControls(fwBtn);
};

muteBtn.onclick = () => {
  video.muted = !video.muted;
  muteBtn.textContent = video.muted ? "ğŸ”‡" : "ğŸ”Š";
  showControls(muteBtn);
};

subsBtn.onclick = () => {
  if (!video.textTracks || video.textTracks.length === 0) return;
  const t = video.textTracks[0];
  t.mode = t.mode === "showing" ? "disabled" : "showing";
  showControls(subsBtn);
};

quality.onchange = () => {
  if (!hls) return;
  const v = quality.value;
  if (v === "-1") {
    hls.currentLevel = -1;
  } else {
    hls.currentLevel = parseInt(v);
  }
  showControls(quality);
};

// 3. Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Seek/Progress Bar (Î¯Î´Î¹Î¿Ï‚)
video.addEventListener("timeupdate", () => {
  if (!video.duration) return;
  fill.style.width = (video.currentTime / video.duration) * 100 + "%";
});

bar.onclick = (e) => {
  const r = bar.getBoundingClientRect();
  const p = (e.clientX - r.left) / r.width;
  if (video.duration) {
    video.currentTime = p * video.duration;
  }
  showControls(); // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Î¼ÎµÏ„Î¬ Ï„Î¿ seek
};

// 4. Android TV/Remote Keydown Logic
window.addEventListener("keydown", (e) => {
  if (e.defaultPrevented) return;

  const active = document.activeElement;

  if (isTV) {
    // 1. Î‘Î Ï„Î¿ video Ï€Î±Î¯Î¶ÎµÎ¹ ÎºÎ±Î¹ Ï€Î±Ï„Î·Î¸ÎµÎ¯ Enter/OK (Î³Î¹Î± pause/play)
    if (
      (e.key === "Enter" || e.key === "OK" || e.keyCode === 13) &&
      active === document.body // Î”Î•Î Î­Ï‡ÎµÎ¹ focus ÎºÎ¬Ï€Î¿Î¹Î¿ control
    ) {
      e.preventDefault();
      video.paused ? video.play() : video.pause();
      // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„Ï‰Î½ controls Î³Î¹Î± Î»Î¯Î³Î¿ Î¼ÎµÏ„Î¬ Ï„Î¿ Play/Pause
      showControls();
      return;
    }

    // 2. Î‘Î Ï€Î±Ï„Î·Î¸ÎµÎ¯ Enter/OK ÏƒÎµ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ control, ÎµÎºÏ„Î­Î»ÎµÏƒÎµ Ï„Î·Î½ ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±
    if (
      (e.key === "Enter" || e.key === "OK" || e.keyCode === 13) &&
      focusableControls.includes(active)
    ) {
      active.click();
      return;
    }

    // 3. Î†Î¼ÎµÏƒÎ· ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„Ï‰Î½ controls Î¼Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Ï€Î»Î®ÎºÏ„ÏÎ¿ D-pad (Ï€Î»Î¿Î®Î³Î·ÏƒÎ·Ï‚)
    if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
      showControls(active);
      return;
    }

    // 4. Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Back/Escape (Î³Î¹Î± Î½Î± ÎºÏÏÎ²Î¿Ï…Î¼Îµ Ï„Î± controls Î±Î½ ÎµÎ¯Î½Î±Î¹ Î±Î½Î¿Î¹Ï‡Ï„Î¬)
    if (e.key === "Escape" || e.key === "Backspace") {
      if (document.body.classList.contains("show-controls")) {
        e.preventDefault();
        hideControls();
        document.body.focus(); // Î‘Ï†Î±Î¯ÏÎµÏƒÎµ focus Î±Ï€ÏŒ ÏŒÎ»Î± Ï„Î± controls
        return;
      }
    }
  }

  // 5. Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï€Î»Î®ÎºÏ„ÏÏ‰Î½ Î³Î¹Î± Fast Forward/Rewind (Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³ÏŒ Ï„Î¿ video)
  if (e.key === "MediaFastForward" || e.key === "ArrowRight") {
    if (!document.activeElement || active === document.body) {
      e.preventDefault();
      fwBtn.click();
      showControls(fwBtn);
    }
  } else if (e.key === "MediaRewind" || e.key === "ArrowLeft") {
    if (!document.activeElement || active === document.body) {
      e.preventDefault();
      rwBtn.click();
      showControls(rwBtn);
    }
  }
});

// 5. Î§ÎµÎ¹ÏÎ¹ÏƒÎ¼ÏŒÏ‚ focus/blur Î³Î¹Î± Desktop (Î³Î¹Î± Î½Î± ÎºÏÏÎ²Î¿Î½Ï„Î±Î¹ ÏŒÏ„Î±Î½ Ï‡Î¬Î½Î¿Ï…Î½ focus)
focusableControls.forEach(el => {
  el.addEventListener("blur", () => {
    // ÎšÏÏÏˆÎµ Ï„Î± controls Î¼ÏŒÎ½Î¿ Î±Î½ Î¿ ÎºÎ­ÏÏƒÎ¿ÏÎ±Ï‚ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î¼ÎµÏ„Î±ÎºÎ¹Î½Î·Î¸ÎµÎ¯ ÏƒÎµ Î¬Î»Î»Î¿ focusable control
    // Î‘Ï…Ï„ÏŒ Ï„Î¿ Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï„Î¿ controlsTimeout Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ showControls
  });
});

</script>
