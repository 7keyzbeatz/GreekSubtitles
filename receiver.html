<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GRMF Netflix Style Cast Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    video {
      width: 100%;
      height: 100%;
      background: black;
    }

    .overlay {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 30px 20px 20px;
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      display: flex;
      flex-direction: column;
      gap: 15px;
      opacity: 1;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }

    .overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .left, .right {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    button, select {
      background: rgba(20,20,20,0.9);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }

    button:hover {
      background: rgba(50,50,50,1);
    }

    .seekbar {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type=range] {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.3);
      outline: none;
      cursor: pointer;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: white;
    }

    #debug {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #00ffcc;
      font-size: 12px;
      padding: 10px;
      border-radius: 10px;
      z-index: 9999;
      white-space: pre-wrap;
      word-break: break-word;
      max-width: 90%;
    }
  </style>
</head>
<body>

<div id="debug">Waiting for stream...</div>
<video id="video" crossorigin="anonymous"></video>

<div id="overlay" class="overlay hidden">

  <div class="seekbar">
    <span id="currentTime">0:00</span>
    <input type="range" id="seek" min="0" max="100" value="0">
    <span id="duration">0:00</span>
  </div>

  <div class="controls">
    <div class="left">
      <button id="backBtn">‚è™ 10s</button>
      <button id="playPauseBtn">‚è∏</button>
      <button id="forwardBtn">10s ‚è©</button>
      <button id="muteBtn">üîä</button>
    </div>

    <div class="right">
      <select id="qualityBtn">
        <option value="auto">AUTO</option>
        <option value="low">LOW</option>
        <option value="mid">MEDIUM</option>
        <option value="high">HIGH</option>
      </select>
    </div>
  </div>
</div>

<script>
const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';

const video = document.getElementById('video');
const debug = document.getElementById('debug');
const overlay = document.getElementById('overlay');

const playPauseBtn = document.getElementById('playPauseBtn');
const backBtn = document.getElementById('backBtn');
const forwardBtn = document.getElementById('forwardBtn');
const muteBtn = document.getElementById('muteBtn');
const seek = document.getElementById('seek');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');
const qualityBtn = document.getElementById('qualityBtn');

let hls = null;
let hideTimeout = null;

function log(msg) {
  debug.textContent = msg;
}

function formatTime(t) {
  if (!t || isNaN(t)) return "0:00";
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60).toString().padStart(2, '0');
  return m + ":" + s;
}

function showUI() {
  overlay.classList.remove('hidden');
  clearTimeout(hideTimeout);
  hideTimeout = setTimeout(() => {
    overlay.classList.add('hidden');
  }, 3000);
}

document.body.addEventListener('mousemove', showUI);

function clearPlayer() {
  if (hls) {
    hls.destroy();
    hls = null;
  }

  video.pause();
  video.removeAttribute('src');
  video.load();

  video.querySelectorAll('track').forEach(t => t.remove());
}

function attachSubs(url) {
  if (!url || !url.endsWith('.vtt')) return;

  const track = document.createElement('track');
  track.kind = 'subtitles';
  track.default = true;
  track.src = url;
  track.label = 'Subs';
  video.appendChild(track);
}

function playStream(url, subUrl) {
  clearPlayer();

  log('Playing:\n' + url);

  if (url.includes('.m3u8') && Hls.isSupported()) {
    hls = new Hls();
    hls.loadSource(url);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      attachSubs(subUrl);
      video.play().catch(()=>{});
      showUI();
    });
  } else {
    video.src = url;
    attachSubs(subUrl);
    video.play().catch(()=>{});
    showUI();
  }
}

// ==== PLAYER EVENTS ====
video.addEventListener('timeupdate', () => {
  seek.value = (video.currentTime / video.duration) * 100 || 0;
  currentTimeEl.textContent = formatTime(video.currentTime);
  durationEl.textContent = formatTime(video.duration);
});

seek.addEventListener('input', () => {
  video.currentTime = (seek.value / 100) * video.duration;
});

playPauseBtn.onclick = () => {
  if (video.paused) {
    video.play();
    playPauseBtn.textContent = '‚è∏';
  } else {
    video.pause();
    playPauseBtn.textContent = '‚ñ∂';
  }
};

backBtn.onclick = () => video.currentTime -= 10;
forwardBtn.onclick = () => video.currentTime += 10;

muteBtn.onclick = () => {
  video.muted = !video.muted;
  muteBtn.textContent = video.muted ? 'üîá' : 'üîä';
};

// UI only Quality (real quality change Œ≥ŒØŒΩŒµœÑŒ±Œπ Œ±œÄœå sender)
qualityBtn.onchange = () => {
  log('Quality UI set to: ' + qualityBtn.value);
};

// ==== CAST LISTENER ====
const context = cast.framework.CastReceiverContext.getInstance();

context.addCustomMessageListener(NAMESPACE, (event) => {
  const data = typeof event.data === 'string'
    ? JSON.parse(event.data)
    : event.data;

  playStream(data.url || '', data.subUrl || '');
});

context.start();
</script>

</body>
</html>
