<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8">
  <title>Fullscreen HLS Cast Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chromecast CAF Receiver SDK -->
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <!-- hls.js -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: sans-serif;
    }

    .player {
      position: fixed;
      inset: 0;
      background: black;
    }

    video {
      width: 100%;
      height: 100%;
      background: black;
      object-fit: contain;
    }

    video::-webkit-media-controls {
      display: none !important;
    }

    .controls {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 20px;
      background: linear-gradient(to top, rgba(0,0,0,.7), transparent 50%);
      opacity: 0;
      transition: .2s ease;
      pointer-events: none;
    }

    .player:hover .controls,
    body.show-controls .controls {
      opacity: 1;
      pointer-events: auto;
    }

    .bar {
      height: 6px;
      background: rgba(255,255,255,.25);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      margin-bottom: 15px;
      position: relative;
    }

    .fill {
      height: 100%;
      background: #1e90ff;
      width: 0%;
    }

    .buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    button, select {
      background: rgba(0,0,0,.7);
      border: 1px solid rgba(255,255,255,.2);
      color: white;
      padding: 12px 16px;
      border-radius: 50px;
      font-size: 14px;
      cursor: pointer;
    }

    .right-controls {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .info {
      position: absolute;
      right: 15px;
      bottom: 15px;
      padding: 6px 10px;
      background: rgba(0,0,0,.6);
      color: #aaa;
      font-size: 11px;
      border-radius: 10px;
      display: flex;
      gap: 10px;
    }

    .status {
      position: absolute;
      left: 15px;
      bottom: 15px;
      padding: 6px 10px;
      background: rgba(0,0,0,.6);
      color: #aaa;
      font-size: 11px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

<div class="player">
  <video id="video" crossorigin="anonymous"></video>

  <div class="controls">
    <div class="bar" id="bar">
      <div class="fill" id="fill"></div>
    </div>

    <div class="buttons">
      <button id="play">â–¶</button>
      <button id="rewind">Â«10</button>
      <button id="forward">10Â»</button>
      <button id="subs" disabled>Subs</button>
    </div>

    <div class="right-controls">
      <select id="quality" disabled>
        <option value="-1">Auto</option>
      </select>
      <button id="mute">ğŸ”Š</button>
    </div>
  </div>

  <div class="info">
    <span id="res">Resolution: auto</span>
    <span id="tech">Idle</span>
  </div>

  <div class="status" id="status">Waiting for cast...</div>
</div>

<script>
/* ===============================
   Î’Î‘Î£Î™ÎšÎ‘ ELEMENTS
================================== */
const video    = document.getElementById("video");
const playBtn  = document.getElementById("play");
const rwBtn    = document.getElementById("rewind");
const fwBtn    = document.getElementById("forward");
const muteBtn  = document.getElementById("mute");
const subsBtn  = document.getElementById("subs");

const bar      = document.getElementById("bar");
const fill     = document.getElementById("fill");
const quality  = document.getElementById("quality");

const resEl    = document.getElementById("res");
const techEl   = document.getElementById("tech");
const statusEl = document.getElementById("status");

let hls = null;
let currentSubTrack = null;

/* ===============================
   CAST RECEIVER SETUP
================================== */
const context       = cast.framework.CastReceiverContext.getInstance();
const playerManager = context.getPlayerManager();

// ÎœÎ—Î ÎºÎ¬Î½ÎµÎ¹ idle timeout Î¿ receiver
context.setInactivityTimeout(0);

/**
 * ÎšÎ±Î»ÎµÎ¯Ï„Î±Î¹ ÏŒÏ„Î±Î½ Î¿ sender ÎºÎ¬Î½ÎµÎ¹ LOAD (RemoteMediaClient.load(getMediaInfo()))
 * ÎµÎ´Ï Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ:
 *  - media.contentId  => video URL (Î±Ï€ÏŒ VideoCast)
 *  - media.tracks[]   => subtitles (SubtitlesServerUrl)
 */
playerManager.setMessageInterceptor(
  cast.framework.messages.MessageType.LOAD,
  (loadRequestData) => {
    const media = loadRequestData.media;
    if (!media) return null;

    const videoUrl = media.contentId;
    let subtitleUrl = null;
    let subtitleLang = "Subtitles";

    if (Array.isArray(media.tracks)) {
      const textTrack =
        media.tracks.find(t => t.type === "TEXT" || t.type === 1) || null;

      if (textTrack) {
        // Î‘Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î·Î½ Î­ÎºÎ´Î¿ÏƒÎ· SDK, Ï„Î¿ URL ÎµÎ¯Î½Î±Î¹ ÎµÎ¯Ï„Îµ trackContentId ÎµÎ¯Ï„Îµ contentId
        subtitleUrl  = textTrack.trackContentId || textTrack.contentId || null;
        subtitleLang = textTrack.language || textTrack.name || "Subtitles";
      }
    }

    statusEl.textContent = "Loading from sender...";
    techEl.textContent   = "Preparing";

    loadPlayer(videoUrl, subtitleUrl, subtitleLang);

    // Î•Ï€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î¼Îµ null Î³Î¹Î± Î½Î± ÎœÎ—Î ÎºÎ¬Î½ÎµÎ¹ auto-load Î¿ default CAF player
    return null;
  }
);

// Î£Ï…Î½Î´Î­Î¿Ï…Î¼Îµ Play/Pause/Seek Î±Ï€ÏŒ Ï„Î¿Î½ sender ÏƒÏ„Î¿ Î´Î¹ÎºÏŒ Î¼Î±Ï‚ <video>
playerManager.addEventListener(
  cast.framework.events.EventType.PLAY,
  () => {
    video.play().catch(() => {});
  }
);

playerManager.addEventListener(
  cast.framework.events.EventType.PAUSE,
  () => {
    video.pause();
  }
);

playerManager.addEventListener(
  cast.framework.events.EventType.SEEKING,
  (e) => {
    if (!isNaN(e.currentTime)) {
      video.currentTime = e.currentTime;
    }
  }
);

// Î•ÎºÎºÎ¯Î½Î·ÏƒÎ· receiver
context.start();

/* ===============================
   PLAYER LOADER (Î§Î©Î¡Î™Î£ HARDCODED URLs)
================================== */
function destroyHls() {
  if (hls) {
    hls.destroy();
    hls = null;
  }
}

function clearSubtitles() {
  const tracks = video.querySelectorAll("track");
  tracks.forEach(t => t.remove());
  currentSubTrack = null;
  subsBtn.disabled = true;
}

function attachSubtitles(subUrl, subLang) {
  clearSubtitles();
  if (!subUrl) return;

  const track = document.createElement("track");
  track.kind = "subtitles";
  track.label = subLang || "Subtitles";
  track.srclang = "el";
  track.src = subUrl;
  track.default = true;
  video.appendChild(track);

  if (video.textTracks && video.textTracks.length > 0) {
    video.textTracks[0].mode = "showing";
  }

  subsBtn.disabled = false;
  currentSubTrack = track;
}

function loadPlayer(videoUrl, subUrl, subLang) {
  destroyHls();
  clearSubtitles();

  if (!videoUrl) {
    statusEl.textContent = "No media URL received";
    techEl.textContent = "Error";
    return;
  }

  statusEl.textContent = "Loading...";
  techEl.textContent = "HTML5";

  if (videoUrl.includes(".m3u8") && Hls.isSupported()) {
    techEl.textContent = "hls.js";
    hls = new Hls({
      enableWorker: true,
      lowLatencyMode: true,
      backBufferLength: 90
    });

    hls.loadSource(videoUrl);
    hls.attachMedia(video);

    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      statusEl.textContent = "Playing";
      video.play().catch(() => {});
      attachSubtitles(subUrl, subLang);
    });

    // Î“ÎµÎ¼Î¯Î¶Î¿Ï…Î¼Îµ Ï€Î¿Î¹ÏŒÏ„Î·Ï„ÎµÏ‚ Î¼Îµ Î±Î½Ï„Î¹ÏƒÏ„ÏÎ¿Ï†Î® (ÏÏƒÏ„Îµ Î½Î± Ï„Î±Î¹ÏÎ¹Î¬Î¶Î¿Ï…Î½ Î¼Îµ Ï„Î± indexes)
    hls.on(Hls.Events.MANIFEST_LOADED, (_, d) => {
      quality.innerHTML = '<option value="-1">Auto</option>';

      const reversed = d.levels
        .map((lvl, i) => ({ lvl, i }))
        .reverse();

      reversed.forEach(item => {
        const opt = document.createElement("option");
        opt.value = item.i; // Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ HLS index
        opt.textContent = item.lvl.height
          ? item.lvl.height + "p"
          : "Level";
        quality.appendChild(opt);
      });

      quality.disabled = false;
    });

    hls.on(Hls.Events.LEVEL_SWITCHED, (_, d) => {
      const level = hls.levels[d.level];
      resEl.textContent = level && level.height
        ? "Resolution: " + level.height + "p"
        : "Resolution: auto";
    });

  } else {
    video.src = videoUrl;
    video.play().catch(() => {});
    statusEl.textContent = "Playing (native)";
    attachSubtitles(subUrl, subLang);
  }

  // Keep-alive Î³Î¹Î± Î½Î± Î¼Î· Î¸ÎµÏ‰ÏÎ·Î¸ÎµÎ¯ idle
  setInterval(() => {
    if (!video.paused && !video.ended) {
      // Î‘Ï€Î»ÏŒ touch ÏƒÏ„Î¿ currentTime ÏÏƒÏ„Îµ Ï„Î¿ runtime Î½Î± Î¼Î·Î½ ÎºÎ¿Î¹Î¼Î·Î¸ÎµÎ¯
      video.currentTime = video.currentTime;
    }
  }, 15000);
}

/* ===============================
   LOCAL CONTROLS (REMOTE + TV)
================================== */
playBtn.onclick = () => video.paused ? video.play() : video.pause();
rwBtn.onclick   = () => { video.currentTime = Math.max(0, video.currentTime - 10); };
fwBtn.onclick   = () => { video.currentTime = video.currentTime + 10; };

muteBtn.onclick = () => {
  video.muted = !video.muted;
  muteBtn.textContent = video.muted ? "ğŸ”‡" : "ğŸ”Š";
};

subsBtn.onclick = () => {
  if (!video.textTracks || video.textTracks.length === 0) return;
  const t = video.textTracks[0];
  t.mode = t.mode === "showing" ? "disabled" : "showing";
};

quality.onchange = () => {
  if (!hls) return;
  const v = quality.value;
  if (v === "-1") {
    hls.currentLevel = -1;
  } else {
    hls.currentLevel = parseInt(v);
  }
};

video.addEventListener("timeupdate", () => {
  if (!video.duration) return;
  fill.style.width = (video.currentTime / video.duration) * 100 + "%";
});

bar.onclick = (e) => {
  const r = bar.getBoundingClientRect();
  const p = (e.clientX - r.left) / r.width;
  if (video.duration) {
    video.currentTime = p * video.duration;
  }
};

/* ===============================
   Android TV / Remote friendly select
================================== */
quality.setAttribute("tabindex", "0");

quality.addEventListener("focus", () => {
  document.body.classList.add("show-controls");
});

window.addEventListener("keydown", (e) => {
  const isTV = /TV|BRAVIA|AFT|Android TV/i.test(navigator.userAgent);
  if (!isTV) return;

  if (
    (e.key === "Enter" || e.key === "OK") &&
    document.activeElement === quality
  ) {
    e.preventDefault();
    quality.click();
    quality.size = quality.options.length;
  }

  if (e.key === "Escape" || e.key === "Backspace") {
    quality.size = 0;
  }
});
</script>

</body>
</html>
