<script>
    const dataViewer = document.getElementById('dataViewer');
    const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';

    function displayData(key, value, clear = false) {
        if (clear) dataViewer.innerHTML = '';

        const entry = document.createElement('div');
        const keySpan = document.createElement('span');
        keySpan.classList.add('label');
        keySpan.textContent = key + ':';

        const valueSpan = document.createElement('span');
        valueSpan.classList.add('value');
        valueSpan.textContent = value;

        entry.appendChild(keySpan);
        entry.appendChild(valueSpan);
        dataViewer.appendChild(entry);
    }

    // CAF Receiver
    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    displayData('STATUS', 'CAF Receiver initialized. Waiting for messages...', true);

    // Ακούμε custom μηνύματα
    context.addCustomMessageListener(NAMESPACE, function (event) {
        displayData('STATUS', 'Custom Message Received!', true);

        try {
            const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

            const videoUrl = data.url || '';

            displayData('MESSAGE TYPE', data.type || 'N/A');
            displayData('VIDEO URL (DIRECT)', videoUrl);
            displayData('SUB URL (DIRECT)', data.subUrl || 'NONE');

            if (!videoUrl || !videoUrl.includes('.m3u8')) {
                displayData('ERROR', 'Το URL δεν είναι m3u8', false);
                return;
            }

            displayData('PLAYER', 'Ξεκινάει η αναπαραγωγή...', false);

            // Δημιουργία Media Info για HLS
            const mediaInfo = new cast.framework.messages.MediaInformation(videoUrl);
            mediaInfo.contentType = 'application/x-mpegURL';
            mediaInfo.streamType = cast.framework.messages.StreamType.BUFFERED;

            const request = new cast.framework.messages.LoadRequestData();
            request.media = mediaInfo;
            request.autoplay = true;

            // Παίξε το video
            playerManager.load(request);

        } catch (e) {
            displayData('ERROR', 'Failed to parse JSON message: ' + e.message, true);
        }
    });

    context.start();
</script>
