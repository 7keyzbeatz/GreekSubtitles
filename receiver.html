<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CAF HLS Receiver + Safe Subtitles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <style>
        body {
            background-color: black;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #00ffcc;
            font-family: monospace;
            font-size: 14px;
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 90%;
            z-index: 9999;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div id="debug">Waiting for cast data...</div>
<cast-media-player></cast-media-player>

<script>
    const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';
    const debug = document.getElementById('debug');

    function log(msg) {
        debug.textContent = msg;
        console.log(msg);
    }

    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    let pendingSubUrl = "";

    log('Receiver ready. Waiting for stream...');

    // Debug player events
    playerManager.addEventListener(
        cast.framework.events.EventType.LOAD_START,
        () => log('LOAD_START… loading stream...')
    );

    playerManager.addEventListener(
        cast.framework.events.EventType.LOADED_DATA,
        () => log('LOADED_DATA ✅ video frames loaded')
    );

    playerManager.addEventListener(
        cast.framework.events.EventType.ERROR,
        (e) => log('PLAYER ERROR: ' + JSON.stringify(e))
    );

    // Receive message from sender (your Android app)
    context.addCustomMessageListener(NAMESPACE, function (event) {
        try {
            const data = typeof event.data === 'string'
                ? JSON.parse(event.data)
                : event.data;

            const videoUrl = data.url || '';
            const subUrl   = data.subUrl || '';

            log('Received:\nVIDEO: ' + videoUrl + '\nSUB: ' + subUrl);

            if (!videoUrl || !videoUrl.includes('.m3u8')) {
                log('ERROR: Invalid video URL');
                return;
            }

            const mediaInfo = new cast.framework.messages.MediaInformation(videoUrl);
            mediaInfo.contentType = 'application/x-mpegURL';
            mediaInfo.streamType = cast.framework.messages.StreamType.BUFFERED;

            const request = new cast.framework.messages.LoadRequestData();
            request.media = mediaInfo;
            request.autoplay = true;

            pendingSubUrl = subUrl;

            playerManager.load(request);

            log('Video loading…');

        } catch (e) {
            log('Receiver error: ' + e.message);
        }
    });

    // Once video is really loaded → attach subs safely
    playerManager.addEventListener(
        cast.framework.events.EventType.LOADED_DATA,
        function () {
            if (!pendingSubUrl || !pendingSubUrl.endsWith('.vtt')) {
                log('No valid subtitles to load.');
                return;
            }

            try {
                const track = new cast.framework.messages.Track(
                    1,
                    cast.framework.messages.TrackType.TEXT
                );

                track.trackContentId = pendingSubUrl;
                track.trackContentType = 'text/vtt';
                track.subtype = cast.framework.messages.TextTrackType.SUBTITLES;
                track.name = 'Subtitles';
                track.language = 'el';

                const media = playerManager.getMediaInformation();
                media.tracks = [track];
                media.textTrackStyle = new cast.framework.messages.TextTrackStyle();

                playerManager.setActiveTrackIds([1]);

                log('✅ Subtitles attached after video load.');
            } catch (e) {
                log('Subtitle attach failed: ' + e.message);
            }
        }
    );

    context.start();
</script>

</body>
</html>
