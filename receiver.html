<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GRMF CAF Receiver - Stable</title>
  <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
  <style>
    body {
      background: black;
      margin: 0;
      overflow: hidden;
    }
    #debug {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: #00ffcc;
      padding: 10px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 13px;
      z-index: 9999;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>

<div id="debug">Waiting...</div>
<cast-media-player></cast-media-player>

<script>
  const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';
  const debug = document.getElementById('debug');

  function log(msg) {
    debug.textContent = msg;
    console.log(msg);
  }

  const context = cast.framework.CastReceiverContext.getInstance();
  const player = context.getPlayerManager();

  let pendingSub = '';

  player.addEventListener(
    cast.framework.events.EventType.ERROR,
    e => log('PLAYER ERROR: ' + JSON.stringify(e))
  );

  context.addCustomMessageListener(NAMESPACE, (event) => {
    try {
      const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
      const videoUrl = data.url || '';
      const subUrl = data.subUrl || '';

      log('Loading…\nVIDEO:\n' + videoUrl + '\nSUB:\n' + subUrl);

      pendingSub = subUrl;

      const media = new cast.framework.messages.MediaInformation(videoUrl);
      media.contentType = 'application/x-mpegURL';
      media.streamType = cast.framework.messages.StreamType.BUFFERED;

      const req = new cast.framework.messages.LoadRequestData();
      req.media = media;
      req.autoplay = true;

      player.load(req);

    } catch(e) {
      log('JSON error: ' + e.message);
    }
  });

  // Προσθήκη subs ΜΕΤΑ το start
  player.addEventListener(
    cast.framework.events.EventType.LOADED_DATA,
    () => {
      if (!pendingSub || !pendingSub.endsWith('.vtt')) {
        log('Video loaded. No subtitles.');
        return;
      }

      try {
        const track = new cast.framework.messages.Track(
          1,
          cast.framework.messages.TrackType.TEXT
        );
        track.trackContentId = pendingSub;
        track.trackContentType = 'text/vtt';
        track.subtype = cast.framework.messages.TextTrackType.SUBTITLES;
        track.name = 'Subtitles';
        track.language = 'el';

        const media = player.getMediaInformation();
        media.tracks = [track];
        media.textTrackStyle = new cast.framework.messages.TextTrackStyle();

        // SAFE enable after delay
        setTimeout(() => {
          try {
            player.setActiveTrackIds([1]);
            log('Subtitles ON ✅');
          } catch(e) {
            log('Subtitle enable failed: ' + e.message);
          }
        }, 1000);

      } catch (e) {
        log('Track error: ' + e.message);
      }
    }
  );

  context.start();
</script>

</body>
</html>
