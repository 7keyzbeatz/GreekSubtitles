<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GRMF CAF Receiver</title>
<script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
</head>
<body>

<script>
const context = cast.framework.CastReceiverContext.getInstance();
const player = context.getPlayerManager();
const NS = 'urn:x-cast:com.med1anetwork.grmf.testchannel';

context.setInactivityTimeout(0);

context.addCustomMessageListener(NS, (event) => {
  try {
    const data = JSON.parse(event.data);

    const media = new cast.framework.messages.MediaInformation();
    media.contentId = data.url;
    media.contentType = data.url.includes(".m3u8")
      ? "application/x-mpegURL"
      : "video/mp4";

    media.streamType = cast.framework.messages.StreamType.BUFFERED;

    if(data.subUrl){
      const track = new cast.framework.messages.Track(
        1, cast.framework.messages.TrackType.TEXT
      );
      track.trackContentId = data.subUrl;
      track.trackContentType = "text/vtt";
      track.subtype = cast.framework.messages.TextTrackType.SUBTITLES;
      media.tracks = [track];
    }

    const req = new cast.framework.messages.LoadRequestData();
    req.media = media;
    req.autoplay = true;
    if(media.tracks) req.activeTrackIds = [1];

    player.load(req);

  } catch(e){ console.log(e); }
});

// Keep alive
player.addEventListener(
  cast.framework.events.EventType.ERROR,
  ()=> console.log("PLAYER ERROR")
);

context.start();
</script>

</body>
</html>
