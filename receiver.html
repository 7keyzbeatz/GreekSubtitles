<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chromecast VOD Receiver + Subs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <style>
        body {
            background-color: black;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #debug {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: #00ffcc;
            font-family: monospace;
            font-size: 14px;
            padding: 12px 16px;
            border-radius: 12px;
            z-index: 9999;
            max-width: 90%;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>

<div id="debug">Waiting for Cast data...</div>

<script>
    const NAMESPACE = 'urn:x-cast:com.med1anetwork.grmf.testchannel';
    const debug = document.getElementById('debug');

    function log(msg) {
        debug.textContent = msg;
    }

    const context = cast.framework.CastReceiverContext.getInstance();
    const playerManager = context.getPlayerManager();

    log('Receiver started. Waiting for video + subtitles...');

    context.addCustomMessageListener(NAMESPACE, function (event) {
        try {
            const data = typeof event.data === 'string'
                ? JSON.parse(event.data)
                : event.data;

            const videoUrl = data.url || '';
            const subUrl   = data.subUrl || '';

            log('VIDEO:\n' + videoUrl + '\n\nSUB:\n' + subUrl);

            if (!videoUrl || !videoUrl.includes('.m3u8')) {
                log('ERROR: Invalid video URL');
                return;
            }

            const mediaInfo = new cast.framework.messages.MediaInformation(videoUrl);
            mediaInfo.contentType = 'application/x-mpegURL';
            mediaInfo.streamType = cast.framework.messages.StreamType.BUFFERED;

            // ====== ΥΠΟΤΙΤΛΟΙ ======
            if (subUrl) {
                const textTrack = new cast.framework.messages.Track(1, cast.framework.messages.TrackType.TEXT);
                textTrack.trackContentId = subUrl;
                textTrack.trackContentType = 'text/vtt';   // VTT format
                textTrack.subtype = cast.framework.messages.TextTrackType.SUBTITLES;
                textTrack.name = 'Greek Subtitles';
                textTrack.language = 'el';

                mediaInfo.tracks = [textTrack];
                mediaInfo.textTrackStyle = new cast.framework.messages.TextTrackStyle();
            }

            const request = new cast.framework.messages.LoadRequestData();
            request.media = mediaInfo;
            request.autoplay = true;

            // Ενεργοποίηση subtitle
            if (subUrl) {
                request.activeTrackIds = [1];
            }

            playerManager.load(request);

            log('Playback with subtitles started ✅');

        } catch (e) {
            log('ERROR: ' + e.message);
        }
    });

    context.start();
</script>

</body>
</html>
